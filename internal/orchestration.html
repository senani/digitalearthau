


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DEA Orchestration &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Collection Management" href="collection_management.html" />
    <link rel="prev" title="Other Modules" href="other_modules.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/DEA-logo-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../connect/account.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../query/Getting Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query/List Products.html">List Products &amp; Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query/Loading Data.html">Loading data from the datacube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query/Advanced Querying.html">Advanced Querying</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook Gallery</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/index.html">Notebook Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_modules.html">Other Modules</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DEA Orchestration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lambda-functions">Lambda Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#raijin-scripts">Raijin Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-internal-modules">Updating internal modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#repo-script-reference">Repo Script Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#collection-installation-on-raijin">Collection Installation on Raijin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="goalkeeper_instructions.html">What’s a Goalkeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>DEA Orchestration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/internal/orchestration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="dea-orchestration">
<h1>DEA Orchestration<a class="headerlink" href="#dea-orchestration" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration">DEA orchestration</a> is a collection of wrapper and helper
libraries for communicating between AWS lambda and NCI’s raijin facilities; and a collection of scripts that can be
triggered within the raijin environment.</p>
<div class="section" id="lambda-functions">
<h2>Lambda Functions<a class="headerlink" href="#lambda-functions" title="Permalink to this headline">¶</a></h2>
<p>To create a new lambda function create a class that inherits from one of the <a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/lambda_modules/dea_raijin/dea_raijin/lambda_commands.py">command classes</a> in the
lambda_modules directory.</p>
<p><strong>To Create a new Lambda Function</strong></p>
<ul class="simple">
<li>A file must be created called <em>{{script_name}}.py</em>, and a correspond <em>{{script_name}}</em> directory.</li>
<li><dl class="first docutils">
<dt>Inside the directory create the following files:</dt>
<dd><ul class="first last">
<li>requirements.txt (with the python dependencies)</li>
<li>If internal modules are required base them from the lambda_modules directory (e.g. ./../dea_raijin</li>
<li>an <em>env_vars.yaml</em> file which documents the environment variables required by the lambda.</li>
</ul>
</dd>
</dl>
</li>
<li>The “command” method needs to be overwritten by the subclass and is invoked to run the command.</li>
<li>The <em>{{script_name}}.py</em> file must include a handler method that accepts the event and context variables
from AWS and instantiates the user defined command class and calls run.</li>
<li>The command must have a class variable “COMMAND_NAME” which is used to identify the command when logging.</li>
<li>To create a new function use <em>./scripts/package_lambda {{script_name}} {{zipfile_name}}</em> to create a packaged
zipfile; this will need to be uploaded into AWS Lambda with the corresponding IAM roles and access to
ec2 parameter store.</li>
<li>Make sure the private keys are stored in
<a class="reference external" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-walk.html">aws ssm</a></li>
<li>By default the user credentials will be retrieved from the ssm parameters:</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">User:</th><td class="field-body">orchestrator.raijin.users.default.user</td>
</tr>
<tr class="field-even field"><th class="field-name">Host:</th><td class="field-body">orchestrator.raijin.users.default.host</td>
</tr>
<tr class="field-odd field"><th class="field-name">Private Key:</th><td class="field-body">orchestrator.raijin.users.default.pkey</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><dl class="first docutils">
<dt>When the lambda is configured it will need an associated role with policy permissions to access</dt>
<dd>the ssm to retrieve parameters and the
<a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html">kms</a> decryption key.
Installs the requirements of a script into the current python env; useful to install internal modules.</dd>
</dl>
</li>
</ul>
<p>An <a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/lambda_functions/example/example.py">example lambda class</a>
is available to use a template.</p>
<p><strong>Writing a new Lambda function</strong></p>
<ul class="simple">
<li>For scripts that inherit from the BaseCommand/RaijinCommand logging
is available with <em>self.logger.{{level}}(‘{{message}}’)</em></li>
<li>For RaijinCommands/BaseCommands the constructor must pass itself into the super constructor
to provide the command name.</li>
<li>For RaijinCommands the ssh_client can be accessed directly by using self.raijin.ssh_client</li>
<li>Use the inbuilt exec_command of self.raijin to use default logging behaviour and have the stdout, stderr, and
exit_code decoded and returned for processing.</li>
<li>BaseCommands can manage the connection themselves by importing and using the RaijinSession object from
dea_raijin.auth</li>
</ul>
<p><strong>To test run a Lambda function</strong></p>
<ul class="simple">
<li>The simplest method to test run a lambda command is to call the run_lambda script in the scripts directory.</li>
<li><dl class="first docutils">
<dt>The script will need to be run from an environment that has access to AWS ssm and AWS kms key.</dt>
<dd><ul class="first last">
<li>This can be done by installing the
<a class="reference external" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">aws cli and invoking aws configure</a></li>
</ul>
</dd>
</dl>
</li>
<li>This script invokes the lambda handler based on the script name after initialising the
environment variables in env_vars.</li>
<li>If additional raijin commands are required they should be submitted first for approval.</li>
</ul>
</div>
<div class="section" id="raijin-scripts">
<h2>Raijin Scripts<a class="headerlink" href="#raijin-scripts" title="Permalink to this headline">¶</a></h2>
<p>Raijin scripts folder contain a list of pre-approved commands that are available to run under one of DEA’s
NCI accounts. Commands in this folder should be locked down to ensure that the user isn’t able to
execute arbitrary code in our environment.</p>
<p><strong>To Create a new Raijin script</strong></p>
<blockquote>
<div><ul class="simple">
<li>create a folder in the raijin_scripts directory with the name of that will be used to invoke the command.</li>
<li>Inside the directory is an executable run file which will be called via the executor with the
commandline arguments passed into the function.</li>
<li>If you require additional files please store them in this directory, for example have a python virtual
environment in order to access libraries please store them in this directory.</li>
<li>If there is work required to install the command, please create an install.sh file in this directory
which is where the code will be executed from following approval.</li>
<li>stderr, stdout and exit_code is returned to the lambda function by default</li>
<li>An exit code of 127 (command not found) is returned if remote cannot find the command requested.</li>
</ul>
</div></blockquote>
<p><strong>Running a Raijin Command</strong></p>
<blockquote>
<div><ul>
<li><p class="first">The entry point to raijin is the ./scripts/remote executable.</p>
</li>
<li><p class="first">If you wish to test raijin commands it can be done from this entry point.</p>
<blockquote>
<div><ul class="simple">
<li>copy the repository into your NCI environment and from the base folder run
<em>./scripts/remote {{raijin_script_name}} {{args}}</em></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="updating-internal-modules">
<h2>Updating internal modules<a class="headerlink" href="#updating-internal-modules" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>To update internal modules in your virtual env run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">--upgrade</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code>
to ensure that your installed copies of the modules are up to date</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="repo-script-reference">
<h2>Repo Script Reference<a class="headerlink" href="#repo-script-reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/scripts/install_script">./scripts/install_script {{script_name}}</a> :
Installs the requirements of a script into the current python env; useful to install internal modules.</li>
<li><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/scripts/package_lambda">./scripts/package_lambda {{script_name}} {{output_zip}}</a> :
Creates a lambda zipfile with dependencies from the scripts’ requirements.txt file which can be used by lambda.</li>
<li><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/scripts/run_lambda">./scripts/run_lambda {{script_name}}</a> :
runs the script importing the environment variables from the env_vars.yaml file.</li>
<li><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/scripts/remote">./scripts/remote {{raijin_script}} {{args}}</a> :
runs the script file in the raijin environment with the passed args; scripts must exist in the raijin folder</li>
<li><a class="reference external" href="https://github.com/GeoscienceAustralia/dea-orchestration/blob/master/scripts/git_pull">./scripts/git_pull</a> :
script to update the repository from the current production branch</li>
</ul>
</div>
<div class="section" id="collection-installation-on-raijin">
<h2>Collection Installation on Raijin<a class="headerlink" href="#collection-installation-on-raijin" title="Permalink to this headline">¶</a></h2>
<p>In order to set up this library on Raijin the user is required to generate 3 ssh keys.</p>
<ul class="simple">
<li>One to be able to access the remote script</li>
<li>One to be able to access the git_pull script (to limit how this is triggered)</li>
<li>One to be able to read from the code repository.</li>
</ul>
<p>The first 2 keys should be appended to the users ~/.ssh/authorized_keys file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">The ssh key for remote should be prepended with</span>
<span class="go">command=&quot;{{directory_location/scripts/remote&quot;,no-agent-forwarding,no-port-forwarding,no-pty,no-user-rc,</span>
<span class="go">no-X11-forwarding ssh-rsa AA3tEnxs/...E4S+UGaYQ== Running of scripts under NCI</span>

<span class="go">The ssh key for git pull should be prepended with</span>
<span class="go">command=&quot;{{directory_location/scripts/git_pull&quot;,no-agent-forwarding,no-port-forwarding,no-pty,no-user-rc,</span>
<span class="go">no-X11-forwarding ssh-rsa AA3tEnxs/...E4S+UGaYQ== Automated deployment of dea-orchestration</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="collection_management.html" class="btn btn-neutral float-right" title="Collection Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="other_modules.html" class="btn btn-neutral" title="Other Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>