


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Generate tidal geomedian filmstrips &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Image Classification" href="../Image_classification/README.html" />
    <link rel="prev" title="Landsat 8 Geomedian Dashboard" href="Landsat8_Geomedian_Dashboard.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/DEA-logo-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect/account.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../query/Getting Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/List Products.html">List Products &amp; Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Loading Data.html">Loading data from the datacube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Advanced Querying.html">Advanced Querying</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Getting_started/README.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEA_datasets/README.html">DEA Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Integrating_external_data/README.html">Integrating External Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Index_calculation/README.html">Index Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temporal_analysis/README.html">Temporal Analyses</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="README.html">Composite Generation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Landsat8_Geomedian_Dashboard.html">Landsat 8 Geomedian Dashboard</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Generate tidal geomedian filmstrips</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Import-modules">Import modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Geomedian-filmstrip-parameters">Geomedian filmstrip parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Return-observations-for-each-sensor-for-the-entire-time-series">Return observations for each sensor for the entire time series</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Subset-data-by-tidal-height-and-epoch-time-range">Subset data by tidal height and epoch time range</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Combine-multiple-sensors,-load-data-and-generate-geomedians">Combine multiple sensors, load data and generate geomedians</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plot-geomedians-as-filmstrips">Plot geomedians as filmstrips</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Create-tidal-modelled-vs-observed-plot">Create tidal modelled vs observed plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Image_classification/README.html">Image Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Outputting_data/README.html">Outputting data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Workflows/README.html">Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Scripts/README.html">Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html">Overview of DEA Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tags.html">Tagging Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/other_modules.html">Other Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/orchestration.html">DEA Orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/goalkeeper_instructions.html">What’s a Goalkeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Guide</a> &raquo;</li>
        
          <li><a href="README.html">Composite Generation</a> &raquo;</li>
        
      <li>Generate tidal geomedian filmstrips</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/Composite_generation/Tidal_Geomedian_Filmstrips.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Generate-tidal-geomedian-filmstrips">
<h1>Generate tidal geomedian filmstrips<a class="headerlink" href="#Generate-tidal-geomedian-filmstrips" title="Permalink to this headline">¶</a></h1>
<p><strong>What does this notebook do?</strong></p>
<p>This notebooks demonstrates how to tidally tag remotely sensed imagery
using the <a class="reference external" href="http://volkov.oce.orst.edu/tides/otps.html">OSU Tidal Prediction Software or
OTPS</a> model, and create
geomedian composites for a given set of epochs and tidal range. These
geomedian composites are exported as geoTIFFs, and plotted as
‘filmstrip’ plots that compare change over time.</p>
<p><strong>Inputs:</strong></p>
<p>Before running this notebook, please ensure that the <code class="docutils literal notranslate"><span class="pre">otps</span></code> module has
been loaded by running: <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">otps</span></code></p>
<p>If you find an error or bug in this notebook, please either create an
‘Issue’ in the Github repository, or fix it yourself and create a ‘Pull’
request to contribute the updated notebook back into the repository (See
the repository
<a class="reference external" href="https://github.com/GeoscienceAustralia/dea-notebooks/blob/master/README.rst">README</a>
for instructions on creating a Pull request).</p>
<p><strong>Date:</strong> June 2018</p>
<p><strong>Author:</strong> Robbi Bishop-Taylor, Claire Phillips</p>
<p><strong>Tags</strong>: <span class="target" id="index-0"></span>tidal_model, <span class="target" id="index-1"></span>OTPS, <span class="target" id="index-2"></span>tidal_tagging, <span class="target" id="index-3"></span>predict_tide, <span class="target" id="index-4"></span>composites, <span class="target" id="index-5"></span>dask, <span class="target" id="index-6"></span>write_geotiff,  <span class="target" id="index-7"></span>filmstrip_plot, <span class="target" id="index-8"></span>geopandas, <span class="target" id="index-9"></span>point_in_polygon</p>
<div class="section" id="Import-modules">
<h2>Import modules<a class="headerlink" href="#Import-modules" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datacube</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">otps</span> <span class="k">import</span> <span class="n">TimePoint</span>
<span class="kn">from</span> <span class="nn">otps</span> <span class="k">import</span> <span class="n">predict_tide</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">datacube.utils</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">datacube.utils.geometry</span> <span class="k">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">datacube_stats.statistics</span> <span class="k">import</span> <span class="n">GeoMedian</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="k">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">datacube.helpers</span> <span class="k">import</span> <span class="n">ga_pq_fuser</span>
<span class="kn">from</span> <span class="nn">datacube.helpers</span> <span class="k">import</span> <span class="n">write_geotiff</span>
<span class="kn">from</span> <span class="nn">datacube.storage</span> <span class="k">import</span> <span class="n">masking</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">FormatStrFormatter</span>

<span class="c1"># For nicer notebook plotting, hide warnings (comment out for real analysis)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Create datacube instance</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">datacube</span><span class="o">.</span><span class="n">Datacube</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="s1">&#39;Tidal geomedian filmstrips&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Generate dates seperated by given time increment/period&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="n">start_date</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">period</span><span class="p">:</span><span class="n">increment</span><span class="p">})</span>
    <span class="k">while</span> <span class="n">nxt</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nxt</span><span class="p">)</span>
        <span class="n">nxt</span> <span class="o">+=</span> <span class="n">delta</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">ds_to_rgb</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">],</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Converts an xarray dataset to a three band array&quot;&quot;&quot;</span>

    <span class="n">rawimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">bands</span><span class="p">]</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">img_toshow</span> <span class="o">=</span> <span class="p">(</span><span class="n">rawimg</span> <span class="o">/</span> <span class="n">reflect_stand</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_toshow</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Geomedian-filmstrip-parameters">
<h2>Geomedian filmstrip parameters<a class="headerlink" href="#Geomedian-filmstrip-parameters" title="Permalink to this headline">¶</a></h2>
<p>Set the area, time period and sensors of interest, and tide limits and
epoch length used to produce each geomedian composite. This is the only
cell that needs to be edited to run the notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up centre of study area and buffer size in metres for data extraction</span>
<span class="n">study_area</span> <span class="o">=</span> <span class="s1">&#39;gulfcarpentaria&#39;</span>  <span class="c1"># name used as prefix for output files</span>
<span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">17.58253</span><span class="p">,</span> <span class="mf">139.82613</span>  <span class="c1"># centre of study area</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="mi">3500</span>  <span class="c1"># metre units to extend region of interest on each side of centre point</span>

<span class="c1"># Set up compositing parameters</span>
<span class="n">time_period</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;1988-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2018-01-01&#39;</span><span class="p">)</span>  <span class="c1"># Total date range to import data from</span>
<span class="n">sensors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ls5&#39;</span><span class="p">,</span> <span class="s1">&#39;ls7&#39;</span><span class="p">,</span> <span class="s1">&#39;ls8&#39;</span><span class="p">]</span>  <span class="c1"># Landsat sensors from which to import data from</span>
<span class="n">ls7_slc_off</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Whether to include striped &gt; May 31 2003 Landsat 7 SLC-off data</span>
<span class="n">lower_tideheight</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># Minimum proportion of the observed tidal range to include</span>
<span class="n">upper_tideheight</span> <span class="o">=</span> <span class="mf">0.6</span>  <span class="c1"># Maximum proportion of the observed tidal range to include</span>
<span class="n">epoch_years</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Length of each epoch used to compute geomedians (i.e. 5 years = 1988 to 1993)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Return-observations-for-each-sensor-for-the-entire-time-series">
<h2>Return observations for each sensor for the entire time series<a class="headerlink" href="#Return-observations-for-each-sensor-for-the-entire-time-series" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">dask</span></code> to lazily load Landsat data and PQ for each sensor for the
entire time series. No data is actually loaded here: this is saved until
after the layers have been filtered by tidal stage and date to save
processing time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># If output data and figure directories doesn&#39;t exist, create them</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;output_data/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;output_data/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;figures/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;figures/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">))</span>

<span class="c1"># Create list of epochs between start and end of time_period in datetime format</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_period</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_period</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">epoch_years</span><span class="p">,</span> <span class="s1">&#39;years&#39;</span><span class="p">)</span>

<span class="c1"># Print list of epochs</span>
<span class="n">epochs_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">epoch</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{}</span><span class="s1"> epochs: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epochs_strings</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epochs_strings</span><span class="p">)))</span>

<span class="c1"># Identify tide point by importing ITEM polygons</span>
<span class="n">polygons_gpd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;/g/data/r78/intertidal/GA_native_tidal_model.shp&#39;</span><span class="p">)</span>
<span class="n">polygon_gpd</span> <span class="o">=</span> <span class="n">polygons_gpd</span><span class="p">[</span><span class="n">polygons_gpd</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))]</span>
<span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span> <span class="o">=</span> <span class="n">polygon_gpd</span><span class="p">[[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using tidepost coordinates: </span><span class="si">{}</span><span class="s1"> E, </span><span class="si">{}</span><span class="s1"> S</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">))</span>

<span class="c1"># Set up query</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;WGS84&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:3577&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">),</span>
         <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">),</span>
         <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time_period</span><span class="p">,</span>
         <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="s1">&#39;EPSG:3577&#39;</span><span class="p">}</span>

<span class="c1"># Output dicts to hold entire time-series for each sensor</span>
<span class="n">sensor_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">pq_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># For each sensor, dask load data and compute tide heights for each sensor</span>
<span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensors</span><span class="p">:</span>

    <span class="c1"># The following code will fail if there is no data for the sensor in time_period;</span>
    <span class="c1"># this try statement catches this and skips the affected sensor</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Return observations matching query without actually loading them using dask</span>
        <span class="n">sensor_all</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_nbart_albers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span>
                         <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span>
                         <span class="n">dask_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                         <span class="o">**</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Load PQ data matching query without actually loading them using dask</span>
        <span class="n">pq_all</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_pq_albers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span>
                        <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span>
                        <span class="n">fuse_func</span><span class="o">=</span><span class="n">ga_pq_fuser</span><span class="p">,</span>
                        <span class="n">dask_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                        <span class="o">**</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Remove Landsat 7 SLC-off from PQ layer if ls7_slc_off = False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ls7_slc_off</span> <span class="ow">and</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s1">&#39;ls7&#39;</span><span class="p">:</span>
            <span class="n">sensor_all</span> <span class="o">=</span> <span class="n">sensor_all</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sensor_all</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;2003-05-30&#39;</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Use the tidal mode to compute tide heights for each observation:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing tidal heights for </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> observations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sensor_all</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">sensor</span><span class="p">))</span>
        <span class="n">obs_datetimes</span> <span class="o">=</span> <span class="n">sensor_all</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">obs_timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">obs_datetimes</span><span class="p">]</span>
        <span class="n">obs_predictedtides</span> <span class="o">=</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">obs_timepoints</span><span class="p">)</span>
        <span class="n">obs_tideheights</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictedtide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">predictedtide</span> <span class="ow">in</span> <span class="n">obs_predictedtides</span><span class="p">]</span>

        <span class="c1"># Assign tide heights to the dataset as a new variable</span>
        <span class="n">sensor_all</span><span class="p">[</span><span class="s1">&#39;tide_heights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">obs_tideheights</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">sensor_all</span><span class="o">.</span><span class="n">time</span><span class="p">)])</span>

        <span class="c1"># Append results for each sensor to a dictionary with sensor name as the key</span>
        <span class="n">sensor_dict</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor_all</span>
        <span class="n">pq_dict</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">pq_all</span>

    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> selection failed due to likely lack of data in time_period; skipping&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing 5 epochs: 1988-01-01, 1994-01-01, 2000-01-01, 2006-01-01, 2012-01-01
Using tidepost coordinates: 140.26 E, -17.52 S

Computing tidal heights for 348 ls5 observations
Computing tidal heights for 78 ls7 observations
Computing tidal heights for 107 ls8 observations
</pre></div></div>
</div>
</div>
<div class="section" id="Subset-data-by-tidal-height-and-epoch-time-range">
<h2>Subset data by tidal height and epoch time range<a class="headerlink" href="#Subset-data-by-tidal-height-and-epoch-time-range" title="Permalink to this headline">¶</a></h2>
<p>Use image time-stamps to compute tidal heights at the time of each
observation, and take a subset of the entire Landsat and PQ time series
based on tide height and epoch date range for each sensor.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># If any sensor has 0 observations, remove it from the dictionary before proceeding</span>
<span class="n">sensor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sensor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># Calculate max and min tide heights for the entire time series and all sensors</span>
<span class="n">obs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">sensor_ds</span><span class="o">.</span><span class="n">tide_heights</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">sensor_ds</span> <span class="ow">in</span> <span class="n">sensor_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<span class="n">obs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">sensor_ds</span><span class="o">.</span><span class="n">tide_heights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">sensor_ds</span> <span class="ow">in</span> <span class="n">sensor_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<span class="n">obs_range</span> <span class="o">=</span> <span class="n">obs_max</span> <span class="o">-</span> <span class="n">obs_min</span>

<span class="c1"># Calculate tidal limits used for subsequent data selection</span>
<span class="n">sel_min</span> <span class="o">=</span> <span class="n">obs_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">obs_range</span> <span class="o">*</span> <span class="n">lower_tideheight</span><span class="p">)</span>
<span class="n">sel_max</span> <span class="o">=</span> <span class="n">obs_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">obs_range</span> <span class="o">*</span> <span class="n">upper_tideheight</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Analysing tidal heights of </span><span class="si">{0:.2f}</span><span class="s1"> m to </span><span class="si">{1:.2f}</span><span class="s1"> m out of an observed local tidal &#39;</span>
      <span class="s1">&#39;range of </span><span class="si">{2:.2f}</span><span class="s1"> m to </span><span class="si">{3:.2f}</span><span class="s1"> m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_min</span><span class="p">,</span> <span class="n">sel_max</span><span class="p">,</span> <span class="n">obs_min</span><span class="p">,</span> <span class="n">obs_max</span><span class="p">))</span>

<span class="c1"># Create dictionaries to hold filtered sensor data for each epoch</span>
<span class="n">sensor_epoch_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">pq_epoch_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">epochs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

    <span class="c1"># Select dataset</span>
    <span class="n">sensor_all</span> <span class="o">=</span> <span class="n">sensor_dict</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>
    <span class="n">pq_all</span> <span class="o">=</span> <span class="n">pq_dict</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>

    <span class="c1"># Filter to keep only observations that have matching PQ data</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor_all</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">pq_all</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">time</span>
    <span class="n">sensor_subset</span> <span class="o">=</span> <span class="n">sensor_all</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
    <span class="n">pq_subset</span> <span class="o">=</span> <span class="n">pq_all</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Filter by tidal stage</span>
    <span class="n">sensor_subset</span> <span class="o">=</span> <span class="n">sensor_subset</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sensor_subset</span><span class="o">.</span><span class="n">tide_heights</span> <span class="o">&gt;=</span> <span class="n">sel_min</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">sensor_subset</span><span class="o">.</span><span class="n">tide_heights</span> <span class="o">&lt;=</span> <span class="n">sel_max</span><span class="p">),</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Filter pq to same timesteps (this avoids conversion to float by `.where`)</span>
    <span class="n">pq_subset</span> <span class="o">=</span> <span class="n">pq_subset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">sensor_subset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Identify from and to date strings</span>
    <span class="n">from_date</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">to_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">epoch_years</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Subset sensor to from and to date for epoch</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Filtering from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">,</span> <span class="n">sensor</span><span class="p">))</span>
    <span class="n">sensor_subset</span> <span class="o">=</span> <span class="n">sensor_subset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">))</span>
    <span class="n">pq_subset</span> <span class="o">=</span> <span class="n">pq_subset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">))</span>

    <span class="c1"># Add subsetted data to dicts (one key matching a list of sensor data for each epoch)</span>
    <span class="n">sensor_epoch_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sensor_subset</span><span class="p">)</span>
    <span class="n">pq_epoch_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq_subset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Analysing tidal heights of -0.14 m to 0.42 m out of an observed local tidal range of -1.24 m to 1.52 m
    Filtering from 1988-01-01 to 1994-01-01 for ls5
    Filtering from 1988-01-01 to 1994-01-01 for ls7
    Filtering from 1988-01-01 to 1994-01-01 for ls8
    Filtering from 1994-01-01 to 2000-01-01 for ls5
    Filtering from 1994-01-01 to 2000-01-01 for ls7
    Filtering from 1994-01-01 to 2000-01-01 for ls8
    Filtering from 2000-01-01 to 2006-01-01 for ls5
    Filtering from 2000-01-01 to 2006-01-01 for ls7
    Filtering from 2000-01-01 to 2006-01-01 for ls8
    Filtering from 2006-01-01 to 2012-01-01 for ls5
    Filtering from 2006-01-01 to 2012-01-01 for ls7
    Filtering from 2006-01-01 to 2012-01-01 for ls8
    Filtering from 2012-01-01 to 2018-01-01 for ls5
    Filtering from 2012-01-01 to 2018-01-01 for ls7
    Filtering from 2012-01-01 to 2018-01-01 for ls8
</pre></div></div>
</div>
</div>
<div class="section" id="Combine-multiple-sensors,-load-data-and-generate-geomedians">
<h2>Combine multiple sensors, load data and generate geomedians<a class="headerlink" href="#Combine-multiple-sensors,-load-data-and-generate-geomedians" title="Permalink to this headline">¶</a></h2>
<p>For each epoch, combine all sensors into one dataset, load the data for
the first time using <code class="docutils literal notranslate"><span class="pre">dask</span></code>’s <code class="docutils literal notranslate"><span class="pre">.compute()</span></code>, then composite all
timesteps into a single array using a geometric median computation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Dict to hold output geomedian composits</span>
<span class="n">geomedian_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">tideheights_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">from_date</span> <span class="ow">in</span> <span class="n">sensor_epoch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

    <span class="c1"># For the first time, actually load data for all sensors and then combine into one dataset</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading and combining </span><span class="si">{}</span><span class="s1"> data for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">from_date</span><span class="p">))</span>
    <span class="n">sensor_combined</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sensor_epoch_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">pq_combined</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pq_epoch_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{}</span><span class="s1"> observations combined&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sensor_combined</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>

    <span class="c1"># Manually add flag definition back in (it is lost during the concatenation)</span>
    <span class="n">pq_combined</span><span class="o">.</span><span class="n">pixelquality</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;flags_definition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pq_all</span><span class="o">.</span><span class="n">pixelquality</span><span class="o">.</span><span class="n">flags_definition</span>

    <span class="c1"># Sort output datasets by date</span>
    <span class="n">sensor_combined</span> <span class="o">=</span> <span class="n">sensor_combined</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">pq_combined</span> <span class="o">=</span> <span class="n">pq_combined</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># Identify pixels with no clouds/shadows in either ACCA for Fmask</span>
    <span class="n">good_quality</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">make_mask</span><span class="p">(</span><span class="n">pq_combined</span><span class="o">.</span><span class="n">pixelquality</span><span class="p">,</span>
                                     <span class="n">cloud_acca</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
                                     <span class="n">cloud_shadow_acca</span><span class="o">=</span><span class="s1">&#39;no_cloud_shadow&#39;</span><span class="p">,</span>
                                     <span class="n">cloud_shadow_fmask</span><span class="o">=</span><span class="s1">&#39;no_cloud_shadow&#39;</span><span class="p">,</span>
                                     <span class="n">cloud_fmask</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
                                     <span class="n">blue_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">green_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">red_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">nir_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">swir1_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">swir2_saturated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Apply mask to set all PQ-affected pixels to NaN and set nodata to NaN</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Applying PQ mask and setting nodata to NaN&#39;</span><span class="p">)</span>
    <span class="n">sensor_combined</span> <span class="o">=</span> <span class="n">sensor_combined</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_quality</span><span class="p">)</span>
    <span class="n">sensor_combined</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">mask_invalid_data</span><span class="p">(</span><span class="n">sensor_combined</span><span class="p">)</span>

    <span class="c1"># Compute geomedian composite using all timesteps</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Computing geometric median&#39;</span><span class="p">)</span>
    <span class="n">geomedian_ds</span> <span class="o">=</span> <span class="n">GeoMedian</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">sensor_combined</span><span class="p">)</span>

    <span class="c1"># Export to file</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;output_data/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">,</span> <span class="n">from_date</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Exporting to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">write_geotiff</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">geomedian_ds</span><span class="p">)</span>

    <span class="c1"># Assign to dict</span>
    <span class="n">geomedian_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">geomedian_ds</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading and combining ls5, ls7, ls8 data for 1988-01-01
    21 observations combined
    Applying PQ mask and setting nodata to NaN
    Computing geometric median
    Exporting to output_data/gulfcarpentaria/gulfcarpentaria_1988-01-01.tif
Loading and combining ls5, ls7, ls8 data for 1994-01-01
    28 observations combined
    Applying PQ mask and setting nodata to NaN
    Computing geometric median
    Exporting to output_data/gulfcarpentaria/gulfcarpentaria_1994-01-01.tif
Loading and combining ls5, ls7, ls8 data for 2000-01-01
    28 observations combined
    Applying PQ mask and setting nodata to NaN
    Computing geometric median
    Exporting to output_data/gulfcarpentaria/gulfcarpentaria_2000-01-01.tif
Loading and combining ls5, ls7, ls8 data for 2006-01-01
    32 observations combined
    Applying PQ mask and setting nodata to NaN
    Computing geometric median
    Exporting to output_data/gulfcarpentaria/gulfcarpentaria_2006-01-01.tif
Loading and combining ls5, ls7, ls8 data for 2012-01-01
    27 observations combined
    Applying PQ mask and setting nodata to NaN
    Computing geometric median
    Exporting to output_data/gulfcarpentaria/gulfcarpentaria_2012-01-01.tif
</pre></div></div>
</div>
</div>
<div class="section" id="Plot-geomedians-as-filmstrips">
<h2>Plot geomedians as filmstrips<a class="headerlink" href="#Plot-geomedians-as-filmstrips" title="Permalink to this headline">¶</a></h2>
<p>Plots geomedians for each epoch as single true and false-colour
filmstrip plots:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up dict of band combinations to iterate through to produce filmstrip plots</span>
<span class="n">band_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;falsecolour&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
             <span class="s1">&#39;truecolour&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]}</span>

<span class="c1"># Load ITEM confidence layer that matches dataset and export to file</span>
<span class="n">item_data</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="s1">&#39;item_v2_conf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="n">write_geotiff</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output_data/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">_itemconf.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">),</span>
              <span class="n">dataset</span><span class="o">=</span><span class="n">item_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">),</span>
              <span class="n">profile_override</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">6666</span><span class="p">})</span>

<span class="c1"># Create a filmstrip plot for each band combination</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">bands</span> <span class="ow">in</span> <span class="n">band_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># Compute number of epochs for figure construction</span>
    <span class="n">epochs_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geomedian_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">{}</span><span class="s1">-panel </span><span class="si">{}</span><span class="s1"> filmstrip plot&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epochs_n</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="c1"># Set up plot with multiple columns (ITEM confidence + n epochs)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epochs_n</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Remove space between subplots</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Plot ITEM confidence in first column</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">,</span>
                   <span class="n">vmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ITEM confidence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># Remove axes ticks and space on left and bottom of plot</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Progressively add epoch geomedians to remaining subplot columns</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">from_date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sensor_epoch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

        <span class="c1"># Compute upper date bound for plot title</span>
        <span class="n">to_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">epoch_years</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Geomedian for given epoch</span>
        <span class="n">epoch_ds</span> <span class="o">=</span> <span class="n">geomedian_dict</span><span class="p">[</span><span class="n">from_date</span><span class="p">]</span>

        <span class="c1"># Convert ds to three band array, using a different reflect_stand</span>
        <span class="c1"># value for True and False colour to produce bright/vibrant plots</span>
        <span class="n">epoch_array</span> <span class="o">=</span> <span class="n">ds_to_rgb</span><span class="p">(</span><span class="n">epoch_ds</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="n">bands</span><span class="p">,</span>
                                <span class="n">reflect_stand</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;falsecolour&#39;</span><span class="p">:</span> <span class="mi">4000</span><span class="p">,</span>
                                               <span class="s1">&#39;truecolour&#39;</span><span class="p">:</span> <span class="mi">2500</span><span class="p">}[</span><span class="n">name</span><span class="p">])</span>

        <span class="c1"># Plot data into column</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">epoch_array</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># Remove axes ticks and space on left and bottom of plot</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Export combined figure to file</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;figures/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Exporting to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Generating 6-panel falsecolour filmstrip plot
    Exporting to figures/gulfcarpentaria/gulfcarpentaria_falsecolour.png
Generating 6-panel truecolour filmstrip plot
    Exporting to figures/gulfcarpentaria/gulfcarpentaria_truecolour.png
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_13_1.png" src="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_13_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_13_2.png" src="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_13_2.png" />
</div>
</div>
</div>
<div class="section" id="Create-tidal-modelled-vs-observed-plot">
<h2>Create tidal modelled vs observed plot<a class="headerlink" href="#Create-tidal-modelled-vs-observed-plot" title="Permalink to this headline">¶</a></h2>
<p>Create a plot comparing selected Landsat observations to all Landsat
observations and the entire tidal history of the study area:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># For each hour between start and end of time series, predict tide and add to list</span>
<span class="n">all_times</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">)</span>
<span class="n">tp_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">]</span>
<span class="n">tides_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">tide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">tide</span> <span class="ow">in</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">tp_model</span><span class="p">)]</span>

<span class="c1"># Covert to dataframe of modelled dates and tidal heights</span>
<span class="n">modelled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;tide_heights&#39;</span><span class="p">:</span> <span class="n">tides_model</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">all_times</span><span class="p">))</span>

<span class="c1"># Return dataframe of previously-generated observed dates and tidal heights</span>
<span class="n">observed_df</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">tide_heights</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sensor_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

<span class="c1"># Set up plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tide height (m)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Tidepost: </span><span class="si">{}</span><span class="s1"> E, </span><span class="si">{}</span><span class="s1"> S (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">study_area</span><span class="p">),</span>
             <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
             <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Plot modelled values as grey background</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">modelled_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">modelled_df</span><span class="o">.</span><span class="n">tide_heights</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gainsboro&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OTPS model&#39;</span><span class="p">)</span>

<span class="c1"># Plot all observations as black points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">observed_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">observed_df</span><span class="o">.</span><span class="n">tide_heights</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;All observations&#39;</span><span class="p">)</span>

<span class="c1"># Plot selected observations in red by clipping observed_df to min and max tide selection</span>
<span class="n">selected_df</span> <span class="o">=</span> <span class="n">observed_df</span><span class="p">[</span><span class="n">observed_df</span><span class="o">.</span><span class="n">tide_heights</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">sel_min</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">sel_max</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">selected_df</span><span class="o">.</span><span class="n">tide_heights</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Selected observations&#39;</span><span class="p">)</span>

<span class="c1"># Plot horizontal lines defining border of selected tidal range</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">sel_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">sel_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Add vertical lines and annotation defining each epoch</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

    <span class="c1"># Compute from and to date strings</span>
    <span class="n">from_date</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">to_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">epoch_years</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Add vertical line and epoch titles</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">),</span>
                 <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">modelled_df</span><span class="o">.</span><span class="n">tide_heights</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                 <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Add legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
           <span class="n">handletextpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Export plot</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;figures/</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">_tideobs.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">study_area</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Exporting to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    Exporting to figures/gulfcarpentaria/gulfcarpentaria_tideobs.png
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_15_1.png" src="../../_images/notebooks_Composite_generation_Tidal_Geomedian_Filmstrips_15_1.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Image_classification/README.html" class="btn btn-neutral float-right" title="Image Classification" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Landsat8_Geomedian_Dashboard.html" class="btn btn-neutral" title="Landsat 8 Geomedian Dashboard" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>