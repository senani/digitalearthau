


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tidal Modelling and Tagging &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Index Calculation" href="../Index_calculation/README.html" />
    <link rel="prev" title="Create a raster mask using a shapefile" href="CreateRasterMaskFromShapefile.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/DEA-logo-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect/account.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../query/Getting Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/List Products.html">List Products &amp; Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Loading Data.html">Loading data from the datacube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Advanced Querying.html">Advanced Querying</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Getting_started/README.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DEA_datasets/README.html">DEA Datasets</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="README.html">Integrating External Data</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="CreateRasterMaskFromShapefile.html">Create a raster mask using a shapefile</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tidal Modelling and Tagging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Import-modules">Import modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Import-remotely-sensed-time-series-data">Import remotely-sensed time series data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Tidal-modelling-using-OTPS">Tidal modelling using OTPS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Ebb-and-flow-tidal-phases">Ebb and flow tidal phases</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Advanced:-computing-tides-without-loading-images-first-using-dask">Advanced: computing tides without loading images first using dask</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Index_calculation/README.html">Index Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temporal_analysis/README.html">Temporal Analyses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Composite_generation/README.html">Composite Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Image_classification/README.html">Image Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Outputting_data/README.html">Outputting data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Workflows/README.html">Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Scripts/README.html">Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html">About this documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html#notebook-gallery-instructions">Notebook Gallery Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tags.html">Tagging Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/other_modules.html">Other Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/orchestration.html">DEA Orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/goalkeeper_instructions.html">What’s a Goalkeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Guide</a> &raquo;</li>
        
          <li><a href="README.html">Integrating External Data</a> &raquo;</li>
        
      <li>Tidal Modelling and Tagging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/Integrating_external_data/TidalModellingandTagging.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Tidal-Modelling-and-Tagging">
<h1>Tidal Modelling and Tagging<a class="headerlink" href="#Tidal-Modelling-and-Tagging" title="Permalink to this headline">¶</a></h1>
<p><strong>What does this notebook do?</strong></p>
<p>This notebooks demonstrates how to tidally tag remotely sensed imagery
using an external tidal model so that images can be extracted or
analysed by tidal stage (e.g. low or high tide). This tidal model (<a class="reference external" href="http://volkov.oce.orst.edu/tides/otps.html">OSU
Tidal Prediction Software or
OTPS</a>) is used to produce
datasets including the Intertidal Extents Model (ITEM), High-Low Tide
Composites (HLTC), and the National Intertidal Digital Elevation Model
(NIDEM).</p>
<p><strong>Inputs:</strong></p>
<p>Before running this notebook, please ensure that the <code class="docutils literal notranslate"><span class="pre">otps</span></code> module has
been loaded by running: <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">otps</span></code></p>
<p>This example also uses an external <code class="docutils literal notranslate"><span class="pre">three_band_image</span></code> function
available in the <code class="docutils literal notranslate"><span class="pre">Scripts</span></code> folder of the <a class="reference external" href="https://github.com/GeoscienceAustralia/dea-notebooks/tree/master/Scripts">dea-notebooks Github
repository</a>.
Note that <code class="docutils literal notranslate"><span class="pre">dea-notebooks</span></code> functions have been developed by DEA users,
not the DEA development team, and so are provided without warranty. If
you find an error or bug in the functions, please either create an
‘Issue’ in the Github repository, or fix it yourself and create a ‘Pull’
request to contribute the updated function back into the repository (See
the repository
<a class="reference external" href="https://github.com/GeoscienceAustralia/dea-notebooks/blob/master/README.rst">README</a>
for instructions on creating a Pull request).</p>
<p><strong>Date:</strong> May 2018</p>
<p><strong>Author:</strong> Robbi Bishop-Taylor</p>
<p><strong>Tags</strong>: <span class="target" id="index-0"></span>tidal_model, <span class="target" id="index-1"></span>OTPS, <span class="target" id="index-2"></span>tidal_tagging, <span class="target" id="index-3"></span>predict_tide, <span class="target" id="index-4"></span>composites, <span class="target" id="index-5"></span>DEAPlotting, <span class="target" id="index-6"></span>three_band_image, <span class="target" id="index-7"></span>datacube.utils.geometry, <span class="target" id="index-8"></span>Scripts, <span class="target" id="index-9"></span>dask</p>
<div class="section" id="Import-modules">
<h2>Import modules<a class="headerlink" href="#Import-modules" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datacube</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">otps</span> <span class="k">import</span> <span class="n">TimePoint</span>
<span class="kn">from</span> <span class="nn">otps</span> <span class="k">import</span> <span class="n">predict_tide</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datacube.utils</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">datacube.utils.geometry</span> <span class="k">import</span> <span class="n">CRS</span>

<span class="c1"># Import external functions from dea-notebooks</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/dea-notebooks/Scripts&#39;</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">DEAPlotting</span>

<span class="c1"># Create datacube instance</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">datacube</span><span class="o">.</span><span class="n">Datacube</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="s1">&#39;Tidal tagging&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-remotely-sensed-time-series-data">
<h2>Import remotely-sensed time series data<a class="headerlink" href="#Import-remotely-sensed-time-series-data" title="Permalink to this headline">¶</a></h2>
<p>Imports a time series of Landsat observations as a DEA <code class="docutils literal notranslate"><span class="pre">xarray</span></code>
dataset, and extracts a list of timestamps based on the time and date of
acquisition for each Landsat observation. These timestamps can then be
used as one of the inputs to the <a class="reference external" href="http://volkov.oce.orst.edu/tides/otps.html">OSU Tidal Prediction Software (OTPS)
tidal model</a>. The input
data does not need to be from Landsat: any remotely-sensed imagery with
timestamps and spatial coordinates provide enough data to run the tidal
model. From <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0034425717301591">Sagar et al.
2015</a>:</p>
<div class="admonition note">
The OTPS TPX08 model [consists] of a multi-resolution bathymetric grid
solution, with a 1/6° solution in the global open ocean, and a 1/30°
local resolution solution to improve modelling in complex shallow water
environments (Egbert and Erofeeva, 2010). The OTPS model is based on a
system of linear partial differential equations, called Laplace’s tidal
equations, parametrised with nine harmonic tidal constituents. The model
is fitted to track-averaged TOPEX/Poseidon altimeter data collected from
1992 to 2016 and Jason-1 (Poseidon 2) altimeter data from 2002 to 2013,
enabling estimation of the tidal height and harmonic constituents at
discrete temporal epochs and spatial locations (Egbert and Erofeeva,
2002).</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up analysis data query</span>
<span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">18.2066466248</span><span class="p">,</span> <span class="mf">122.214634558</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;WGS84&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:3577&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">8000</span><span class="p">),</span>
         <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">8000</span><span class="p">),</span>
         <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="s1">&#39;EPSG:3577&#39;</span><span class="p">,</span>
         <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-06-30&#39;</span><span class="p">)}</span>

<span class="c1"># Import data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;ls8_nbart_albers&#39;</span><span class="p">,</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># Extract list of datetimes based on Landsat time of acquisition for each image</span>
<span class="n">observed_datetimes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">observed_datetimes</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[datetime.datetime(2015, 1, 6, 1, 55, 20), datetime.datetime(2015, 1, 15, 1, 49, 32), datetime.datetime(2015, 1, 22, 1, 55, 15), datetime.datetime(2015, 1, 31, 1, 49, 27), datetime.datetime(2015, 2, 7, 1, 55, 12), datetime.datetime(2015, 2, 16, 1, 49, 19), datetime.datetime(2015, 2, 23, 1, 55, 5), datetime.datetime(2015, 3, 11, 1, 54, 55), datetime.datetime(2015, 3, 20, 1, 49, 5), datetime.datetime(2015, 3, 27, 1, 54, 47), datetime.datetime(2015, 4, 5, 1, 48, 53), datetime.datetime(2015, 4, 12, 1, 54, 40), datetime.datetime(2015, 4, 21, 1, 48, 52), datetime.datetime(2015, 4, 28, 1, 54, 34), datetime.datetime(2015, 5, 7, 1, 48, 37), datetime.datetime(2015, 5, 14, 1, 54, 18), datetime.datetime(2015, 5, 23, 1, 48, 34), datetime.datetime(2015, 5, 30, 1, 54, 22), datetime.datetime(2015, 6, 8, 1, 48, 43), datetime.datetime(2015, 6, 15, 1, 54, 34), datetime.datetime(2015, 6, 24, 1, 48, 50)]
</pre></div></div>
</div>
</div>
<div class="section" id="Tidal-modelling-using-OTPS">
<h2>Tidal modelling using OTPS<a class="headerlink" href="#Tidal-modelling-using-OTPS" title="Permalink to this headline">¶</a></h2>
<p>Uses the previously extracted list of <code class="docutils literal notranslate"><span class="pre">datetime</span></code> objects and specified
lat-long tide post coordinates to compute tidal heights at the time of
acquisition of each Landsat observation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set a tide post: this is the location the OTPS model uses to compute tides for the supplied datetimes</span>
<span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">tidepost_lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">18.2066466248</span><span class="p">,</span> <span class="mf">122.214634558</span>

<span class="c1"># The OTPS model requires inputs as &#39;TimePoint&#39; objects, which are combinations of lon-lat coordinates</span>
<span class="c1"># and a datetime object. You can create a list of these with a list comprehension:</span>
<span class="n">observed_timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">observed_datetimes</span><span class="p">]</span>

<span class="c1"># Feed the entire list of timepoints to the OTPS `predict_tide` function:</span>
<span class="n">observed_predictedtides</span> <span class="o">=</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">observed_timepoints</span><span class="p">)</span>

<span class="c1"># For each of the predicted tide objects, extract a list of tidal heights in `m` units relative to mean</span>
<span class="c1"># sea level (the `tide_m` method should not be confused with the `depth_m` method, which gives you the</span>
<span class="c1"># ocean depth at the tide post location that is used by the OTPS model to predict tides)</span>
<span class="n">observed_tideheights</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictedtide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">predictedtide</span> <span class="ow">in</span> <span class="n">observed_predictedtides</span><span class="p">]</span>

<span class="c1"># Create a dataframe of tidal heights for each Landsat observation</span>
<span class="n">observed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;tide_height&#39;</span><span class="p">:</span> <span class="n">observed_tideheights</span><span class="p">},</span>
                           <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">observed_datetimes</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">observed_df</span><span class="p">)</span>

<span class="c1"># Plot tidal heights against Landsat observation date</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">observed_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">observed_df</span><span class="o">.</span><span class="n">tide_height</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelled&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Landsat observations by tidal height (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tide height (m)&#39;</span><span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tide_height</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-06 01:55:20</th>
      <td>2.093</td>
    </tr>
    <tr>
      <th>2015-01-15 01:49:32</th>
      <td>-1.355</td>
    </tr>
    <tr>
      <th>2015-01-22 01:55:15</th>
      <td>1.947</td>
    </tr>
    <tr>
      <th>2015-01-31 01:49:27</th>
      <td>0.392</td>
    </tr>
    <tr>
      <th>2015-02-07 01:55:12</th>
      <td>0.563</td>
    </tr>
    <tr>
      <th>2015-02-16 01:49:19</th>
      <td>0.918</td>
    </tr>
    <tr>
      <th>2015-02-23 01:55:05</th>
      <td>-0.874</td>
    </tr>
    <tr>
      <th>2015-03-11 01:54:55</th>
      <td>-1.164</td>
    </tr>
    <tr>
      <th>2015-03-20 01:49:05</th>
      <td>3.243</td>
    </tr>
    <tr>
      <th>2015-03-27 01:54:47</th>
      <td>-1.848</td>
    </tr>
    <tr>
      <th>2015-04-05 01:48:53</th>
      <td>2.713</td>
    </tr>
    <tr>
      <th>2015-04-12 01:54:40</th>
      <td>-1.650</td>
    </tr>
    <tr>
      <th>2015-04-21 01:48:52</th>
      <td>2.030</td>
    </tr>
    <tr>
      <th>2015-04-28 01:54:34</th>
      <td>-0.380</td>
    </tr>
    <tr>
      <th>2015-05-07 01:48:37</th>
      <td>1.114</td>
    </tr>
    <tr>
      <th>2015-05-14 01:54:18</th>
      <td>0.178</td>
    </tr>
    <tr>
      <th>2015-05-23 01:48:34</th>
      <td>-0.881</td>
    </tr>
    <tr>
      <th>2015-05-30 01:54:22</th>
      <td>1.288</td>
    </tr>
    <tr>
      <th>2015-06-08 01:48:43</th>
      <td>-1.743</td>
    </tr>
    <tr>
      <th>2015-06-15 01:54:34</th>
      <td>2.655</td>
    </tr>
    <tr>
      <th>2015-06-24 01:48:50</th>
      <td>-1.930</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_8_1.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_8_1.png" />
</div>
</div>
<div class="section" id="Tagging,-filtering-and-compositing-Landsat-observations-by-tidal-height/stage">
<h3>Tagging, filtering and compositing Landsat observations by tidal height/stage<a class="headerlink" href="#Tagging,-filtering-and-compositing-Landsat-observations-by-tidal-height/stage" title="Permalink to this headline">¶</a></h3>
<p>Adds tidal height data back into our original <code class="docutils literal notranslate"><span class="pre">xarray</span></code> dataset so that
each Landsat observation is correctly tagged with its corresponding
tidal height. Tagged images can then be filtered or composited to study
characteristics of the coastline at various tidal stages.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Tag each of our Landsat observations with its matching tide height by creating a new xarray dataset</span>
<span class="c1"># using our tide heights and observation times, and then combining this with our original dataset.</span>
<span class="c1"># This ensures that tide heights are correctly associated with the time dimension of the xarray dataset</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;tide_heights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">observed_tideheights</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)])</span>

<span class="c1"># To demonstrate how tidally tagged images can be used to produce composites of high and low tide</span>
<span class="c1"># imagery, we can compute the lowest 20th and highest 80th percentile tide heights, and use these to</span>
<span class="c1"># filter our observations:</span>
<span class="n">low_height</span><span class="p">,</span> <span class="n">high_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_heights</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">80</span><span class="p">])</span>
<span class="n">filtered_high</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_heights</span> <span class="o">&gt;</span> <span class="n">high_height</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">filtered_low</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_heights</span> <span class="o">&lt;</span> <span class="n">low_height</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Take the simple median of each set of low and high tide observations to produce a composite.</span>
<span class="c1"># (Alternatively, observations could be combined using a geomedian to keep band relationships consistent)</span>
<span class="n">median_high</span> <span class="o">=</span> <span class="n">filtered_high</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">median_low</span> <span class="o">=</span> <span class="n">filtered_low</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot the resulting low and high tide composites in false-color</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">DEAPlotting</span><span class="o">.</span><span class="n">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">median_high</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                                       <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Median of high tide images&#39;</span><span class="p">,</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">DEAPlotting</span><span class="o">.</span><span class="n">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">median_low</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                                       <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Median of low tide images&#39;</span><span class="p">,</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_10_1.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_10_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_10_2.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_10_2.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Ebb-and-flow-tidal-phases">
<h2>Ebb and flow tidal phases<a class="headerlink" href="#Ebb-and-flow-tidal-phases" title="Permalink to this headline">¶</a></h2>
<p>By comparing tide heights 15 minutes before the before and after the
observed Landsat observation, we can determine whether the tide was
rising (flow tide) or falling (ebb tide):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Model tides 15 minutes before each Landsat observation:</span>
<span class="n">td</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">preobs_timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">td</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">observed_datetimes</span><span class="p">]</span>
<span class="n">preobs_predictedtides</span> <span class="o">=</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">preobs_timepoints</span><span class="p">)</span>
<span class="n">preobs_tideheights</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictedtide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">predictedtide</span> <span class="ow">in</span> <span class="n">preobs_predictedtides</span><span class="p">]</span>

<span class="c1"># Now compute tides for 15 minutes after the observation:</span>
<span class="n">postobs_timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">td</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">observed_datetimes</span><span class="p">]</span>
<span class="n">postobs_predictedtides</span> <span class="o">=</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">postobs_timepoints</span><span class="p">)</span>
<span class="n">postobs_tideheights</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictedtide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">predictedtide</span> <span class="ow">in</span> <span class="n">postobs_predictedtides</span><span class="p">]</span>

<span class="c1"># Compare the two tide heights: if the tides decrease over the 30 minute period the tide is &quot;ebbing&quot;;</span>
<span class="c1"># if it increases the tide is &quot;flowing&quot;</span>
<span class="n">observed_phase</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Flow&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">pre</span> <span class="o">&gt;</span> <span class="n">post</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Ebb&quot;</span> <span class="k">for</span> <span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span> <span class="ow">in</span>
                  <span class="nb">zip</span><span class="p">(</span><span class="n">preobs_tideheights</span><span class="p">,</span> <span class="n">postobs_tideheights</span><span class="p">)]</span>

<span class="c1"># Add phase to datatrame of Landsat observations</span>
<span class="n">observed_df</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed_phase</span>
<span class="n">display</span><span class="p">(</span><span class="n">observed_df</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tide_height</th>
      <th>phase</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-06 01:55:20</th>
      <td>2.093</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-01-15 01:49:32</th>
      <td>-1.355</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-01-22 01:55:15</th>
      <td>1.947</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-01-31 01:49:27</th>
      <td>0.392</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-02-07 01:55:12</th>
      <td>0.563</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-02-16 01:49:19</th>
      <td>0.918</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-02-23 01:55:05</th>
      <td>-0.874</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-03-11 01:54:55</th>
      <td>-1.164</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-03-20 01:49:05</th>
      <td>3.243</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-03-27 01:54:47</th>
      <td>-1.848</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-04-05 01:48:53</th>
      <td>2.713</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-04-12 01:54:40</th>
      <td>-1.650</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-04-21 01:48:52</th>
      <td>2.030</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-04-28 01:54:34</th>
      <td>-0.380</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-05-07 01:48:37</th>
      <td>1.114</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-05-14 01:54:18</th>
      <td>0.178</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-05-23 01:48:34</th>
      <td>-0.881</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-05-30 01:54:22</th>
      <td>1.288</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-06-08 01:48:43</th>
      <td>-1.743</td>
      <td>Ebb</td>
    </tr>
    <tr>
      <th>2015-06-15 01:54:34</th>
      <td>2.655</td>
      <td>Flow</td>
    </tr>
    <tr>
      <th>2015-06-24 01:48:50</th>
      <td>-1.930</td>
      <td>Ebb</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="Ebb-and-flow-tide-composites">
<h3>Ebb and flow tide composites<a class="headerlink" href="#Ebb-and-flow-tide-composites" title="Permalink to this headline">¶</a></h3>
<p>Using tidal phase data, we can also create composites of the landscape
during falling and rising tides. This may be particularly useful in
environments like large tidal flats or mangrove forests where water may
remain in the landscape for considerable time after the tidal peak.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add back into</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;tide_phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">observed_phase</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)])</span>

<span class="c1"># To demonstrate how tidally tagged images can be used to produce composites of high and low tide</span>
<span class="c1"># imagery, we can compute the lowest 20th and highest 80th percentile tide heights, and use these</span>
<span class="c1"># to filter our observations:</span>
<span class="n">filtered_flow</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_phase</span> <span class="o">==</span> <span class="s1">&#39;Flow&#39;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">filtered_ebb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_phase</span> <span class="o">==</span> <span class="s1">&#39;Ebb&#39;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Take the median of each set of low and high tide observations to produce a composite:</span>
<span class="n">median_flow</span> <span class="o">=</span> <span class="n">filtered_flow</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">median_ebb</span> <span class="o">=</span> <span class="n">filtered_ebb</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot the resulting low and high tide composites in false-color:</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">DEAPlotting</span><span class="o">.</span><span class="n">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">median_flow</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                                       <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Median of flow tide images&#39;</span><span class="p">,</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">DEAPlotting</span><span class="o">.</span><span class="n">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">median_ebb</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                                       <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Median of ebb tide images&#39;</span><span class="p">,</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_14_1.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_14_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_14_2.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_14_2.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Advanced:-computing-tides-without-loading-images-first-using-dask">
<h2>Advanced: computing tides without loading images first using dask<a class="headerlink" href="#Advanced:-computing-tides-without-loading-images-first-using-dask" title="Permalink to this headline">¶</a></h2>
<p>It is also possible to compute tides for satellite observations that
have not yet been loaded from the datacube. To achieve this, we can use
<code class="docutils literal notranslate"><span class="pre">dask</span></code>, which allows us to ‘queue’ up xarray operations so that we
only need run our analyses <em>after</em> we have obtained a filtered subset of
our data.</p>
<p>If you are only interested in a small number of images with specific
tidal conditions, this is likely to be far more efficient than using
<code class="docutils literal notranslate"><span class="pre">dc.load</span></code> to load in an entire time series of observations first and
then filtering by tide!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Return observations that match our query without actually loading them using dask. If you inspect the</span>
<span class="c1"># arrays contained inside the new xarray dataset, you will see that it is made up of `dask.array` arrays.</span>
<span class="c1"># These are not actually loaded into memory, but we can still apply xarray functions to them like</span>
<span class="c1"># normal before finally running all our operations in one go using the `.compute()` method</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s2">&quot;ls8_nbart_albers&quot;</span><span class="p">,</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span> <span class="n">dask_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># We can extract dates for each observation like normal:</span>
<span class="n">observed_datetimes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;M8[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Use the tidal mode to extract tide heights for each observation:</span>
<span class="n">test_timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimePoint</span><span class="p">(</span><span class="n">tidepost_lon</span><span class="p">,</span> <span class="n">tidepost_lat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">observed_datetimes</span><span class="p">]</span>
<span class="n">test_predictedtides</span> <span class="o">=</span> <span class="n">predict_tide</span><span class="p">(</span><span class="n">test_timepoints</span><span class="p">)</span>
<span class="n">test_tideheights</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictedtide</span><span class="o">.</span><span class="n">tide_m</span> <span class="k">for</span> <span class="n">predictedtide</span> <span class="ow">in</span> <span class="n">test_predictedtides</span><span class="p">]</span>

<span class="c1"># Assign these tide heights back into the dataset:</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;tide_heights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">test_tideheights</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)])</span>

<span class="c1"># As before, filter out all but the lowest 20th percentile tide heights:</span>
<span class="n">low_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_heights</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">])</span>
<span class="n">filtered_low</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tide_heights</span> <span class="o">&lt;</span> <span class="n">low_height</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">filtered_low</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;xarray.Dataset&gt;
Dimensions:          (time: 4, x: 641, y: 641)
Coordinates:
  * time             (time) datetime64[ns] 2015-03-27T01:54:47 ...
  * y                (y) float64 -1.977e+06 -1.977e+06 -1.977e+06 -1.977e+06 ...
  * x                (x) float64 -1.042e+06 -1.042e+06 -1.042e+06 -1.041e+06 ...
Data variables:
    coastal_aerosol  (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    blue             (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    green            (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    red              (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    nir              (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    swir1            (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    swir2            (time, y, x) float64 dask.array&lt;shape=(4, 641, 641), chunksize=(1, 641, 641)&gt;
    tide_heights     (time) float64 -1.848 -1.65 -1.743 -1.93
Attributes:
    crs:      EPSG:3577
</pre></div></div>
</div>
<div class="section" id="Loading-and-compositing-filtered-subset-of-observations">
<h3>Loading and compositing filtered subset of observations<a class="headerlink" href="#Loading-and-compositing-filtered-subset-of-observations" title="Permalink to this headline">¶</a></h3>
<p>Up to this point, none of our operations have actually been run:
<code class="docutils literal notranslate"><span class="pre">dask</span></code> has simply stacked them up in a queue while it waits for us to
run the <code class="docutils literal notranslate"><span class="pre">compute()</span></code> method. When we do this, dask will load in only
our filtered subset of data, which significantly decreases processing
speed:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Run `compute()` to load only our filtered datasets:</span>
<span class="n">filtered_low</span> <span class="o">=</span> <span class="n">filtered_low</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># Now we can take the median of each set of low and high tide observations to produce a composite:</span>
<span class="n">median_low</span> <span class="o">=</span> <span class="n">filtered_low</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># The result should be identical to the low-tide composite we produced earlier, despite taking</span>
<span class="c1"># only a fraction of the time to process:</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">DEAPlotting</span><span class="o">.</span><span class="n">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">median_low</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;swir1&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                                       <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Median of low tide images&#39;</span><span class="p">,</span> <span class="n">reflect_stand</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_18_1.png" src="../../_images/notebooks_Integrating_external_data_TidalModellingandTagging_18_1.png" />
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Index_calculation/README.html" class="btn btn-neutral float-right" title="Index Calculation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="CreateRasterMaskFromShapefile.html" class="btn btn-neutral" title="Create a raster mask using a shapefile" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>