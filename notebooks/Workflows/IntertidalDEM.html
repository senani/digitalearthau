


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Intertidal Digital Elevation Model &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Scripts" href="../Scripts/README.html" />
    <link rel="prev" title="View Landsat 8 imagery for a chosen time period" href="RetrieveLandsat8ViewAndExport.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/DEA-logo-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect/account.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../query/Getting Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/List Products.html">List Products &amp; Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Loading Data.html">Loading data from the datacube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Advanced Querying.html">Advanced Querying</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../DEA_datasets/README.html">DEA Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Integrating_external_data/README.html">Integrating External Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Index_calculation/README.html">Index Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Temporal_analysis/README.html">Temporal Analyses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Composite_generation/README.html">Composite Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Image_classification/README.html">Image Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Outputting_data/README.html">Outputting data</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="README.html">Workflows</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="RetrieveLandsat8ViewAndExport.html">View Landsat 8 imagery for a chosen time period</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Intertidal Digital Elevation Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Load-modules-and-define-functions">Load modules and define functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Set-up-analysis">Set up analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ITEM-interval-boundary-value-extraction">ITEM interval boundary value extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Import-and-prepare-ITEM-OFFSET">Import and prepare ITEM OFFSET</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Extract-contours">Extract contours</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Interpolate-contours-using-TIN/Delaunay-triangulation-interpolation">Interpolate contours using TIN/Delaunay triangulation interpolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Validation">Validation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Scripts/README.html">Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html">About this repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html#notebook-gallery-instructions">Notebook Gallery Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tags.html">Tagging Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/other_modules.html">Other Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/orchestration.html">DEA Orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/goalkeeper_instructions.html">What’s a Goalkeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">User Guide</a> &raquo;</li>
        
          <li><a href="README.html">Workflows</a> &raquo;</li>
        
      <li>Intertidal Digital Elevation Model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/Workflows/IntertidalDEM.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Intertidal-Digital-Elevation-Model">
<h1>Intertidal Digital Elevation Model<a class="headerlink" href="#Intertidal-Digital-Elevation-Model" title="Permalink to this headline">¶</a></h1>
<p><strong>What does this notebook do?</strong> This notebook uses the ITEM 2.0 product
to compute continuous elevation data for Australia’s intertidal zone. It
initially imports ITEM OFFSET files and median tidal elevations for each
tidal interval, computes elevations at interval boundaries, extracts
contours around each tidal interval, and then interpolates between these
contours using TIN/Delaunay triangulation linear interpolation. This
interpolation method preserves the tidal interval boundaries of ITEM
2.0. The notebook exports the contours used for interpolation as line
shapefiles and the resulting DEM as a geotiff, and finally performs a
simple validation using RTK GPS data.</p>
<p><strong>Date:</strong> March 2018</p>
<p><strong>Author:</strong> Robbi Bishop-Taylor</p>
<p>Tags: <span class="target" id="index-0"></span>ITEM, <span class="target" id="index-1"></span>interpolation, <span class="target" id="index-2"></span>digital_elevation_model, <span class="target" id="index-3"></span>intertidal_zone</p>
<div class="section" id="Load-modules-and-define-functions">
<h2>Load modules and define functions<a class="headerlink" href="#Load-modules-and-define-functions" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">MultiLineString</span><span class="p">,</span> <span class="n">mapping</span>
<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="k">import</span> <span class="n">from_epsg</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="k">import</span> <span class="n">gdal</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">nd</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">measure</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Import DEA Notebooks scripts</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/g/data/r78/rt1527/dea-notebooks/algorithms&#39;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">DEADataHandling</span> <span class="k">import</span> <span class="n">array_to_geotiff</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO: Investigate scipy.interpolate.RectBivariateSpline, scipy.interpolate.interp2d,</span>
<span class="sd">spipy.interpolate.RegularGridInterpolator, sklearn.gaussian_process.GaussianProcess</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace value of invalid cells by the value of the nearest</span>
<span class="sd">    cell with valid data</span>

<span class="sd">    :attr data: numpy array of any dimension</span>
<span class="sd">    :attr invalid: a binary array of same shape as &#39;data&#39;. Data value</span>
<span class="sd">                   are replaced where invalid is True. Defaults to</span>
<span class="sd">                   np.isnan(data) if no layer is given</span>

<span class="sd">    :returns: Array with invalid values filled with nearest valid data value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If no invalid array is given, default to setting invalid based on nan</span>
    <span class="k">if</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">invalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">invalid</span><span class="p">,</span>
                                    <span class="n">return_distances</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Set-up-analysis">
<h2>Set up analysis<a class="headerlink" href="#Set-up-analysis" title="Permalink to this headline">¶</a></h2>
<p>Set up path to data and polygon to process. <code class="docutils literal notranslate"><span class="pre">plotting_subset</span></code> does not
affect the analysis, but can be used to provide more useful zoomed-in
plots.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Working directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/g/data/r78/rt1527/item_dem&quot;</span><span class="p">)</span>

<span class="c1"># Path to ITEM offset product</span>
<span class="n">item_offset_path</span> <span class="o">=</span> <span class="s2">&quot;/g/data2/v10/ITEM/offset_products&quot;</span>

<span class="c1"># Set ITEM polygon for analysis</span>
<span class="n">polygon_ID</span> <span class="o">=</span> <span class="mi">33</span>

<span class="c1"># Zoom-in for plots (has no effect on analysis but allows you to plot a zoomed-in subset)</span>
<span class="c1"># plotting_subset = np.index_exp[:, :]</span>
<span class="n">plotting_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">index_exp</span><span class="p">[</span><span class="mi">1750</span><span class="p">:</span> <span class="mi">1950</span><span class="p">,</span> <span class="mi">930</span><span class="p">:</span><span class="mi">1130</span><span class="p">]</span>

<span class="c1"># Print run details</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing polygon </span><span class="si">{0}</span><span class="s2"> from </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon_ID</span><span class="p">,</span> <span class="n">item_offset_path</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing polygon 33 from /g/data2/v10/ITEM/offset_products
</pre></div></div>
</div>
</div>
<div class="section" id="ITEM-interval-boundary-value-extraction">
<h2>ITEM interval boundary value extraction<a class="headerlink" href="#ITEM-interval-boundary-value-extraction" title="Permalink to this headline">¶</a></h2>
<p>ITEM offset values represent the median tidal height for each tidal
interval (<a class="reference external" href="https://doi.org/10.1016/j.rse.2017.04.009">Sagar et al.
2015</a>). Because ITEM tidal
intervals are linearly spaced by design, this code uses a simple linear
model to extract new offset values for each interval boundary (e.g. the
boundary between ITEM interval 1 and 2). This allows us to assign a more
appropriate tidal height to the contours that divide the ITEM tidal
intervals than would be possible through simply assigning median tidal
heights to the downhill or uphill contours.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Import ITEM elevation classes</span>
<span class="n">item_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/elevation.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_offset_path</span><span class="p">),</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;str&quot;</span><span class="p">)</span>
<span class="n">item_offsets</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">):[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">item_offsets</span><span class="p">}</span>
<span class="n">interval_offsets</span> <span class="o">=</span> <span class="n">item_offsets</span><span class="p">[</span><span class="n">polygon_ID</span><span class="p">]</span>

<span class="c1"># Create dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;item_interval&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                   <span class="s2">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">interval_offsets</span><span class="p">})</span>

<span class="c1"># Compute linear model and calculate</span>
<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;item_interval&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;elevation&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">interval_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">contour_offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">interval_boundaries</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Plot output</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;item_interval&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;elevation&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">xticks</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_interval&#39;</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">interval_boundaries</span><span class="p">,</span> <span class="n">contour_offsets</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interval_boundaries</span><span class="p">,</span> <span class="n">contour_offsets</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xc</span> <span class="ow">in</span> <span class="n">interval_boundaries</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contour_offsets</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">interval_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">contour_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ITEM OFFSET interval boundaries&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Workflows_IntertidalDEM_7_0.png" src="../../_images/notebooks_Workflows_IntertidalDEM_7_0.png" />
</div>
</div>
</div>
<div class="section" id="Import-and-prepare-ITEM-OFFSET">
<h2>Import and prepare ITEM OFFSET<a class="headerlink" href="#Import-and-prepare-ITEM-OFFSET" title="Permalink to this headline">¶</a></h2>
<p>Imports ITEM OFFSET raster for given polygon, and prepares by removing
nodata and adding in artificially low minimum interval to ensure correct
contour extraction.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Import raster and extract shape, projection info and geotransform data</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/ITEM_OFFSET_</span><span class="si">{1}</span><span class="s2">_*.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_offset_path</span><span class="p">,</span> <span class="n">polygon_ID</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">src_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">srcarray</span> <span class="o">=</span> <span class="n">src_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
<span class="n">yrows</span><span class="p">,</span> <span class="n">xcols</span> <span class="o">=</span> <span class="n">srcarray</span><span class="o">.</span><span class="n">shape</span>
<span class="n">prj</span> <span class="o">=</span> <span class="n">src_ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
<span class="n">geotrans</span> <span class="o">=</span> <span class="n">src_ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
<span class="n">upleft_x</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">x_rotation</span><span class="p">,</span> <span class="n">upleft_y</span><span class="p">,</span> <span class="n">y_rotation</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">geotrans</span>

<span class="c1"># Copy original data so array can be modified</span>
<span class="n">item_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">srcarray</span><span class="p">)</span>

<span class="c1"># Set nodata to NaN, and force 0 values to a low negative  (-9999) to allow correct</span>
<span class="c1"># contour extraction (i.e. make &quot;0&quot; data sit beneath the lowest ITEM tidal stage)</span>
<span class="n">item_array</span><span class="p">[</span><span class="n">item_array</span> <span class="o">==</span> <span class="o">-</span><span class="mi">6666</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">item_array</span><span class="p">[</span><span class="n">item_array</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

<span class="c1"># Dilate data area of array by two pixels to eliminate NA contours on tile edges</span>
<span class="c1"># (this only affects pixels directly on the boundary of two polygon arrays)</span>
<span class="n">dilated_array</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">item_array</span><span class="p">),</span>  <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">item_array</span> <span class="o">=</span> <span class="n">fill</span><span class="p">(</span><span class="n">item_array</span><span class="p">)</span>
<span class="n">item_array</span><span class="p">[</span><span class="o">~</span><span class="n">dilated_array</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Plot original data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item_array</span><span class="p">[</span><span class="n">plotting_subset</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Workflows_IntertidalDEM_9_0.png" src="../../_images/notebooks_Workflows_IntertidalDEM_9_0.png" />
</div>
</div>
</div>
<div class="section" id="Extract-contours">
<h2>Extract contours<a class="headerlink" href="#Extract-contours" title="Permalink to this headline">¶</a></h2>
<p>Uses <code class="docutils literal notranslate"><span class="pre">scikit.measure.find_contours</span></code> to rapidly extract contour
boundaries between ITEM tidal intervals, and assigns these contours with
previously calculated elevation values. Contours are exported as line
shapefiles to assist in subsequent assessment of output DEMs.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Output dict to hold contours for each offset</span>
<span class="n">contour_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">contour_offset</span> <span class="ow">in</span> <span class="n">contour_offsets</span><span class="p">:</span>

        <span class="c1"># Extract contours from array</span>
        <span class="n">contours</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">item_array</span><span class="p">,</span> <span class="n">contour_offset</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting contour </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contour_offset</span><span class="p">))</span>

        <span class="c1"># Iterate through each contour feature, remove NAs and fix coordinates</span>
        <span class="n">contour_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>

            <span class="c1"># Convert index coordinates to spatial coordinates in-place</span>
            <span class="n">contour</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">upleft_y</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">contour</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">upleft_x</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">contour_offset</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Remove contour points with NAs</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">contour</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">contour_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>

        <span class="c1"># Add list of contour arrays to dict</span>
        <span class="n">contour_dict</span><span class="p">[</span><span class="n">contour_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour_list</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">)</span>


<span class="c1"># Export contours to line shapefile to assist in evaluating DEMs</span>
<span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span>  <span class="s1">&#39;MultiLineString&#39;</span><span class="p">,</span>
          <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span> <span class="p">}</span> <span class="p">}</span>

<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;output_data/ITEM_DEM_</span><span class="si">{}</span><span class="s2">_lines.shp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon_ID</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
                <span class="n">crs</span> <span class="o">=</span> <span class="n">from_epsg</span><span class="p">(</span><span class="mi">3577</span><span class="p">),</span>
                <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;ESRI Shapefile&quot;</span><span class="p">,</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">elevation_value</span><span class="p">,</span> <span class="n">contour_list</span> <span class="ow">in</span> <span class="n">contour_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># Filter out contours with less than two points (i.e. non-lines)</span>
        <span class="n">contour_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">contour_list</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create multiline string by first flipping coordinates then creating list of linestrings</span>
        <span class="n">contour_linestrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">LineString</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="n">contour_array</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">contour_array</span> <span class="ow">in</span> <span class="n">contour_list</span><span class="p">]</span>
        <span class="n">contour_multilinestring</span> <span class="o">=</span> <span class="n">MultiLineString</span><span class="p">(</span><span class="n">contour_linestrings</span><span class="p">)</span>

        <span class="c1"># Write output shapefile to file with elevation field</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">elevation_value</span><span class="p">)</span> <span class="p">},</span>
                      <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">contour_multilinestring</span><span class="p">)</span> <span class="p">})</span>

<span class="c1"># Chain and concatenate all arrays nested within array lists (i.e. individual collections of same</span>
<span class="c1"># elevation contours) and dictionary entries (i.e. collections of all same-elevation contours)</span>
<span class="n">alldata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">contour_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">alldata</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">alldata</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Extracting contour -2749
Extracting contour -2190
Extracting contour -1630
Extracting contour -1071
Extracting contour -511
Extracting contour 47
Extracting contour 607
Extracting contour 1167
Extracting contour 1726
Extracting contour 2286
</pre></div></div>
</div>
</div>
<div class="section" id="Interpolate-contours-using-TIN/Delaunay-triangulation-interpolation">
<h2>Interpolate contours using TIN/Delaunay triangulation interpolation<a class="headerlink" href="#Interpolate-contours-using-TIN/Delaunay-triangulation-interpolation" title="Permalink to this headline">¶</a></h2>
<p>Exports a DEM by interpolating previously extracted contours. This uses
the linear method from <code class="docutils literal notranslate"><span class="pre">scipy.interpolate.griddata</span></code>, which computes a
TIN/Delaunay triangulation of the input data using Qhull before
performing linear barycentric interpolation on each triangle.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Extract bounds of ITEM layer</span>
<span class="n">minx</span> <span class="o">=</span> <span class="n">upleft_x</span>
<span class="n">maxx</span> <span class="o">=</span> <span class="n">upleft_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_size</span> <span class="o">*</span> <span class="n">xcols</span><span class="p">)</span>
<span class="n">miny</span> <span class="o">=</span> <span class="n">upleft_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_size</span> <span class="o">*</span> <span class="n">yrows</span><span class="p">)</span>
<span class="n">maxy</span> <span class="o">=</span> <span class="n">upleft_y</span>

<span class="c1"># Create interpolation grid (from, to, by in metres)</span>
<span class="n">grid_y</span><span class="p">,</span> <span class="n">grid_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">maxy</span><span class="p">:</span><span class="n">miny</span><span class="p">:</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">yrows</span><span class="p">,</span>
                          <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">:</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">xcols</span><span class="p">]</span>

<span class="c1"># Interpolate between points onto grid. This uses the &#39;linear&#39; method from</span>
<span class="c1"># scipy.interpolate.griddata, which computes a TIN/Delaunay triangulation of the input</span>
<span class="c1"># data with Qhull and performs linear barycentric interpolation on each triangle</span>
<span class="n">interpolated_array</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">grid_y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="c1"># Mask out NaNs, zero values and max tidal stage from original ITEM offset layer</span>
<span class="n">gooddata_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">srcarray</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">6666</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">srcarray</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">srcarray</span> <span class="o">!=</span> <span class="n">interval_offsets</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
<span class="n">interpolated_array</span><span class="p">[</span><span class="o">~</span><span class="n">gooddata_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">interpolated_array</span><span class="p">[</span><span class="n">plotting_subset</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Export resulting DEM as a geotif</span>
<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;output_data/ITEM_DEM_</span><span class="si">{}</span><span class="s2">.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon_ID</span><span class="p">),</span>
                 <span class="n">data</span> <span class="o">=</span> <span class="n">interpolated_array</span><span class="p">,</span>
                 <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">geotrans</span><span class="p">,</span>
                 <span class="n">projection</span> <span class="o">=</span> <span class="n">prj</span><span class="p">,</span>
                 <span class="n">nodata_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Workflows_IntertidalDEM_13_0.png" src="../../_images/notebooks_Workflows_IntertidalDEM_13_0.png" />
</div>
</div>
</div>
<div class="section" id="Validation">
<h2>Validation<a class="headerlink" href="#Validation" title="Permalink to this headline">¶</a></h2>
<p>Test the resulting DEM by comparing against RTK GPS field-recorded data.
Because validation data only exists for polygon 33 (Darwin), this
imports DEM data for polygon 33 if another polygon is being analysed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Because validation data only exists for polygon 33, use this data to compare to validation values</span>
<span class="k">if</span> <span class="n">polygon_ID</span> <span class="o">!=</span> <span class="mi">33</span><span class="p">:</span>

    <span class="c1"># Import polygon 33 from file</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing ITEM_DEM_33.tif from file&quot;</span><span class="p">)</span>
    <span class="n">poly33_ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;output_data/ITEM_DEM_33.tif&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interpolated_array</span> <span class="o">=</span> <span class="n">poly33_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

    <span class="c1"># Get projection</span>
    <span class="n">geotrans</span> <span class="o">=</span> <span class="n">poly33_ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
    <span class="n">upleft_x</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">x_rotation</span><span class="p">,</span> <span class="n">upleft_y</span><span class="p">,</span> <span class="n">y_rotation</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">geotrans</span>


<span class="c1"># Open validation point shapefile and use to extract data from underlying array</span>
<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;raw_data/EastPointonlyRTK_albers.shp&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">points</span><span class="p">:</span>

    <span class="n">point_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>

        <span class="c1"># Extract data from shapefile points; fix units by multiplying by 1000</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
        <span class="n">val_elev</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;field_4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span>

        <span class="c1"># Convert geographic coordinates into index coordinates</span>
        <span class="n">x_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">upleft_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_size</span><span class="p">)</span> <span class="c1"># x pixel</span>
        <span class="n">y_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">upleft_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_size</span><span class="p">)</span> <span class="c1"># y pixel</span>

        <span class="c1"># Extract modelled elevation from DEM array</span>
        <span class="n">mod_elev</span> <span class="o">=</span> <span class="n">interpolated_array</span><span class="p">[</span><span class="n">y_ind</span><span class="p">,</span> <span class="n">x_ind</span><span class="p">]</span>

        <span class="c1"># Append to list</span>
        <span class="n">point_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">val_elev</span><span class="p">,</span> <span class="n">mod_elev</span><span class="p">])</span>

<span class="c1"># Combine into dataframe</span>
<span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;val_elevation&quot;</span><span class="p">,</span> <span class="s2">&quot;mod_elevation&quot;</span><span class="p">]</span>
<span class="n">modval_elev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">point_output</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">modval_elev</span> <span class="o">=</span> <span class="n">modval_elev</span><span class="p">[</span><span class="n">modval_elev</span><span class="p">[</span><span class="s1">&#39;val_elevation&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2500</span><span class="p">]</span>

<span class="c1"># Compute linear model</span>
<span class="n">m</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">modval_elev</span><span class="p">[</span><span class="s2">&quot;val_elevation&quot;</span><span class="p">],</span> <span class="n">modval_elev</span><span class="p">[</span><span class="s2">&quot;mod_elevation&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">modval_rsquared</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;val_elevation~mod_elevation&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">modval_elev</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">rsquared</span>

<span class="c1"># Plot output x-y scatter plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">modval_elev</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;val_elevation&quot;</span><span class="p">,</span>
                 <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;mod_elevation&quot;</span><span class="p">,</span>
                 <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
                 <span class="n">s</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">modval_elev</span><span class="p">[</span><span class="s2">&quot;val_elevation&quot;</span><span class="p">],</span> <span class="n">m</span> <span class="o">*</span> <span class="n">modval_elev</span><span class="p">[</span><span class="s2">&quot;val_elevation&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;val_elevation ~ mod_elevation, R-squared = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">modval_rsquared</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_Workflows_IntertidalDEM_15_0.png" src="../../_images/notebooks_Workflows_IntertidalDEM_15_0.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Scripts/README.html" class="btn btn-neutral float-right" title="Scripts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="RetrieveLandsat8ViewAndExport.html" class="btn btn-neutral" title="View Landsat 8 imagery for a chosen time period" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>