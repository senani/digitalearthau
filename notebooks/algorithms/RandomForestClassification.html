


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Random forest classification &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Case Studies" href="../case_studies/README.html" />
    <link rel="prev" title="ProduceFalseColourGeotiffs" href="ProduceFalseColourGeotiffs.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/DEA-logo-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect/account.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../query/Getting Started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/List Products.html">List Products &amp; Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query/Loading Data.html">Loading data from the datacube</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebook Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Notebook Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../products/README.html">Products</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="README.html">Algorithms</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ProduceFalseColourGeotiffs.html">ProduceFalseColourGeotiffs</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Random forest classification</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Import-modules-and-define-functions">Import modules and define functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Functions-used-to-import-training-and-analysis-data">Functions used to import training and analysis data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Set-up-analysis">Set up analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Import-training-data-and-fit-model">Import training data and fit model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Import-analysis-data-and-classify">Import analysis data and classify</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Feature/band/variable-importance">Feature/band/variable importance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plot-performance-of-model-by-parameter-values">Plot performance of model by parameter values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Export-tree-diagrams">Export tree diagrams</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../case_studies/README.html">Case Studies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workflows/README.html">Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html">Notebook Gallery Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tags.html">Tagging Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html#user-instructions">User instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html#maintainer-instructions">Maintainer Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/orchestration.html">DEA Orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/goalkeeper_instructions.html">What’s a Goalkeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Notebook Gallery</a> &raquo;</li>
        
          <li><a href="README.html">Algorithms</a> &raquo;</li>
        
      <li>Random forest classification</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/algorithms/RandomForestClassification.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Random-forest-classification">
<h1>Random forest classification<a class="headerlink" href="#Random-forest-classification" title="Permalink to this headline">¶</a></h1>
<p><strong>What does this notebook do?</strong> This notebook classifies remote sensing
data using a random forest classifier model. Key features include being
able to efficiently import training data from a set of point, line or
polygon shapefiles (i.e. data is extracted from each shapefile
separately to avoid slow <code class="docutils literal notranslate"><span class="pre">dc.load</span></code> on large areas), and allow flexible
and consistent selection of training and analysis data using import
functions (i.e. ensuring training data is consistent with analysis
data). The notebook exports geotiff classification outputs and a series
of evaluation figures to help fine-tune the classifier.</p>
<p><strong>Date:</strong> March 2018</p>
<p><strong>Author:</strong> Robbi Bishop-Taylor</p>
<p>“<strong>Tags</strong>: <span class="target" id="index-0"></span>image_classification, <span class="target" id="index-1"></span>machine_learning, <span class="target" id="index-2"></span>random_forest, <span class="target" id="index-3"></span>Landsat8, <span class="target" id="index-4"></span>mangroves, <span class="target" id="index-5"></span>tasseled_cap</p>
<div class="section" id="Import-modules-and-define-functions">
<h2>Import modules and define functions<a class="headerlink" href="#Import-modules-and-define-functions" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Load modules</span>
<span class="kn">import</span> <span class="nn">datacube</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">datacube.utils</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">datacube.utils.geometry</span> <span class="k">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="k">import</span> <span class="n">export_graphviz</span>

<span class="c1"># # Import DEA Notebooks scripts</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/g/data/r78/rt1527/dea-notebooks/algorithms&#39;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">ClassificationTools</span> <span class="k">import</span> <span class="n">randomforest_train</span>
<span class="kn">from</span> <span class="nn">ClassificationTools</span> <span class="k">import</span> <span class="n">randomforest_classify</span>
<span class="kn">from</span> <span class="nn">ClassificationTools</span> <span class="k">import</span> <span class="n">randomforest_eval</span>
<span class="kn">from</span> <span class="nn">DEAPlotting</span> <span class="k">import</span> <span class="n">three_band_image</span>
<span class="kn">from</span> <span class="nn">DEADataHandling</span> <span class="k">import</span> <span class="n">tasseled_cap</span>
<span class="kn">from</span> <span class="nn">DEADataHandling</span> <span class="k">import</span> <span class="n">load_nbarx</span>

<span class="c1"># For nicer notebook plotting, hide warnings (comment out for real analysis)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Set up datacube instance</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">datacube</span><span class="o">.</span><span class="n">Datacube</span><span class="p">(</span><span class="n">app</span> <span class="o">=</span> <span class="s1">&#39;Random forest classification&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Functions-used-to-import-training-and-analysis-data">
<h2>Functions used to import training and analysis data<a class="headerlink" href="#Functions-used-to-import-training-and-analysis-data" title="Permalink to this headline">¶</a></h2>
<p>Both of these functions import datacube data using a query, and return
an xarray dataset with multiple bands/variables and <code class="docutils literal notranslate"><span class="pre">crs</span></code> and
<code class="docutils literal notranslate"><span class="pre">affine</span></code> attributes. This format is required as an input to both
<code class="docutils literal notranslate"><span class="pre">randomforest_train</span></code> and <code class="docutils literal notranslate"><span class="pre">randomforest_classify</span></code> to ensure that both
training and analysis data are consistent.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">hltc_import</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports high and low composite data for a given spatial query, and</span>
<span class="sd">    return an xarray dataset with &#39;crs&#39; and &#39;affine&#39; attributes</span>

<span class="sd">    :attr query: spatial query for datacube.load()</span>
<span class="sd">    :returns: xarray dataset with &#39;crs&#39; and &#39;affine&#39; attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Import data</span>
    <span class="n">low_tide</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;low_tide_comp_20p&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>
    <span class="n">high_tide</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;high_tide_comp_20p&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># Rename variables in each high/low composite so datasets can be merged</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">low_tide</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>
    <span class="n">low_tide</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">var</span><span class="p">:</span> <span class="s2">&quot;lt_&quot;</span> <span class="o">+</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data_vars</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">high_tide</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">var</span><span class="p">:</span> <span class="s2">&quot;ht_&quot;</span> <span class="o">+</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data_vars</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Combine into one dataset</span>
    <span class="n">output_xarray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">auto_combine</span><span class="p">([</span><span class="n">low_tide</span><span class="p">,</span> <span class="n">high_tide</span><span class="p">])</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Set attributes</span>
    <span class="n">output_xarray</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_tide</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">output_xarray</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;affine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_tide</span><span class="o">.</span><span class="n">affine</span>

    <span class="k">return</span> <span class="n">output_xarray</span>


<span class="k">def</span> <span class="nf">tc_import</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper around load_nbarx and tasseled_cap to return an xarray dataset with</span>
<span class="sd">    &#39;crs&#39; and &#39;affine&#39; attributes</span>

<span class="sd">    :attr query: query for datacube call; for training, supply only</span>
<span class="sd">    non-spatial queries as spatial are generated from training data</span>
<span class="sd">    :returns: xarray dataset with &#39;crs&#39; and &#39;affine&#39; attributes</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import cleaned Landsat bands data</span>
    <span class="n">nbart_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_nbarx</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="s2">&quot;ls8&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="c1"># Compute tasseled cap indices and take median of multiple timesteps</span>
    <span class="n">output_xarray</span> <span class="o">=</span> <span class="n">tasseled_cap</span><span class="p">(</span><span class="n">sensor_data</span> <span class="o">=</span> <span class="n">nbart_data</span><span class="p">,</span>
                                 <span class="n">sensor</span> <span class="o">=</span> <span class="s1">&#39;ls8&#39;</span><span class="p">,</span>
                                 <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_xarray</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Set-up-analysis">
<h2>Set up analysis<a class="headerlink" href="#Set-up-analysis" title="Permalink to this headline">¶</a></h2>
<p>Defines parameters used for analysis. This notebook contains example
analyses for two classification tasks: classifying mangroves using
high-low tide composites (HLTC), and tasseled cap classification. Run
either of the two cells below to select the desired analysis.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">###########################################</span>
<span class="c1"># For HLTC-based mangrove classification: #</span>
<span class="c1">###########################################</span>

<span class="c1"># Working directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/g/data/r78/rt1527/random_forest&quot;</span><span class="p">)</span>

<span class="c1"># List of training files to import. Shapefiles can be either points, lines or polygons,</span>
<span class="c1"># but must be in the same projection system as the remote sensing dataset being analysed.</span>
<span class="c1"># Each file should cover a small enough spatial area so as to not slow dc.load function</span>
<span class="c1"># excessively (e.g. 100 x 100km max)</span>
<span class="n">train_shps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;raw_data/train/training_data_mangrove.shp&quot;</span><span class="p">,</span>
              <span class="s2">&quot;raw_data/train/training_data_mangrove1.shp&quot;</span><span class="p">,</span>
              <span class="s2">&quot;raw_data/train/training_data_mangrove2.shp&quot;</span><span class="p">,</span>
              <span class="s2">&quot;raw_data/train/training_data_mangrove3.shp&quot;</span><span class="p">]</span>

<span class="c1"># Output path for classified geotiff</span>
<span class="n">classification_output</span> <span class="o">=</span> <span class="s2">&quot;output_data/classification_dc_mangrove.tif&quot;</span>

<span class="c1"># Optional dict to re-map training shapefile classes; useful for combining classes</span>
<span class="c1"># (&#39;3:2&#39; re-maps class 3 to class 2)</span>
<span class="c1"># train_reclass = {1:1, 2:2, 3:2, 4:2}</span>
<span class="n">train_reclass</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Names of output classification classes</span>
<span class="c1"># classification_names = [&quot;mangrove&quot;, &quot;other&quot;]</span>
<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mangrove&quot;</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="s2">&quot;veg&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]</span>

<span class="c1"># Set data function used to import data and optional parameters (e.g. time for temporal data).</span>
<span class="c1"># For example, &#39;tc_import&#39; needs an additional &#39;time&#39; query as it draws on Landsat time-series</span>
<span class="c1"># data, while &#39;hltc_import&#39; uses high-low tide composites that have no temporal dimension</span>
<span class="n">data_func</span> <span class="o">=</span> <span class="n">hltc_import</span>
<span class="n">data_func_params</span> <span class="o">=</span> <span class="p">{}</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##########################################</span>
<span class="c1"># For Tasseled cap-based classification: #</span>
<span class="c1">##########################################</span>

<span class="c1"># Working directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/g/data/r78/rt1527/random_forest&quot;</span><span class="p">)</span>

<span class="c1"># List of training files to import. Shapefiles can be either points, lines or polygons,</span>
<span class="c1"># but must be in the same projection system as the remote sensing dataset being analysed.</span>
<span class="c1"># Each file should cover a small enough spatial area so as to not slow dc.load function</span>
<span class="c1"># excessively (e.g. 100 x 100km max)</span>
<span class="n">train_shps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;raw_data/train/training_data_tasseledcap.shp&quot;</span><span class="p">]</span>

<span class="c1"># Output path for classified geotiff</span>
<span class="n">classification_output</span> <span class="o">=</span> <span class="s2">&quot;output_data/classification_dc_tasseledcap.tif&quot;</span>

<span class="c1"># Optional dict to re-map training shapefile classes; useful for combining classes</span>
<span class="c1"># (&#39;3:2&#39; re-maps class 3 to class 2)</span>
<span class="n">train_reclass</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Names of output classification classes</span>
<span class="n">classification_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;wetland&quot;</span><span class="p">,</span> <span class="s2">&quot;escarpment&quot;</span><span class="p">,</span> <span class="s2">&quot;plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;other_wetland&quot;</span><span class="p">]</span>

<span class="c1"># Set data function used to import data and optional parameters (e.g. time for temporal data).</span>
<span class="c1"># For example, &#39;tc_import&#39; needs an additional &#39;time&#39; query as it draws on Landsat time-series</span>
<span class="c1"># data, while &#39;hltc_import&#39; uses high-low tide composites that have no temporal dimension</span>
<span class="n">data_func</span> <span class="o">=</span> <span class="n">tc_import</span>
<span class="n">data_func_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2017-03-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-06-28&#39;</span><span class="p">)}</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-training-data-and-fit-model">
<h2>Import training data and fit model<a class="headerlink" href="#Import-training-data-and-fit-model" title="Permalink to this headline">¶</a></h2>
<p>Uses <code class="docutils literal notranslate"><span class="pre">randomforest_train</span></code> to extract training data from potentially
multiple training shapefiles, and returns a trained classifier (and
optionally, training label and training sample arrays)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Dict of classifier parameters</span>
<span class="n">classifier_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                     <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;oob_score&#39;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">}</span>

<span class="c1"># Extract training data for each training shapefile and train classifier</span>
<span class="n">classifier</span><span class="p">,</span> <span class="n">train_lab</span><span class="p">,</span> <span class="n">train_samp</span> <span class="o">=</span> <span class="n">randomforest_train</span><span class="p">(</span><span class="n">train_shps</span> <span class="o">=</span> <span class="n">train_shps</span><span class="p">,</span>
                                                       <span class="n">train_field</span> <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
                                                       <span class="n">data_func</span> <span class="o">=</span> <span class="n">data_func</span><span class="p">,</span>
                                                       <span class="n">data_func_params</span> <span class="o">=</span> <span class="n">data_func_params</span><span class="p">,</span>
                                                       <span class="n">classifier_params</span> <span class="o">=</span> <span class="n">classifier_params</span><span class="p">,</span>
                                                       <span class="n">train_reclass</span> <span class="o">=</span> <span class="n">train_reclass</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Importing training data from raw_data/train/training_data_mangrove.shp:
{&#39;x&#39;: (-96195.37617727809, -159027.5762163046), &#39;y&#39;: (-1293746.4245350992, -1349139.5474466463), &#39;crs&#39;: &#39;EPSG:3577&#39;}
Importing training data from raw_data/train/training_data_mangrove1.shp:
{&#39;x&#39;: (-248822.2628674942, -269215.4139100249), &#39;y&#39;: (-1570514.9681683218, -1590991.9822624666), &#39;crs&#39;: &#39;EPSG:3577&#39;}
Importing training data from raw_data/train/training_data_mangrove2.shp:
{&#39;x&#39;: (-216770.8137106544, -237605.05985552695), &#39;y&#39;: (-1630468.8744477245, -1646265.5913745423), &#39;crs&#39;: &#39;EPSG:3577&#39;}
Importing training data from raw_data/train/training_data_mangrove3.shp:
{&#39;x&#39;: (-699112.9082409441, -724416.739027992), &#39;y&#39;: (-1612261.936734104, -1634952.3249203684), &#39;crs&#39;: &#39;EPSG:3577&#39;}

Training random forest classifier...
Model trained on 12 bands and 352 training samples
</pre></div></div>
</div>
</div>
<div class="section" id="Import-analysis-data-and-classify">
<h2>Import analysis data and classify<a class="headerlink" href="#Import-analysis-data-and-classify" title="Permalink to this headline">¶</a></h2>
<p>Classifies and exports an analysis dataset using a previously trained
random forest classifier, provided this dataset has the same number of
bands/variables as the data used to train the classifier. Using the same
data function used to train the classifier (e.g. <code class="docutils literal notranslate"><span class="pre">data_func</span></code>
previously defined as either <code class="docutils literal notranslate"><span class="pre">tc_import</span></code> or <code class="docutils literal notranslate"><span class="pre">hltc_import</span></code>) will
ensure this is the case. By setting <code class="docutils literal notranslate"><span class="pre">class_prob</span> <span class="pre">=</span> <span class="pre">True</span></code>, you can
optionally export a geotiff of predicted class probabilities in addition
to the classification output.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up analysis data query</span>
<span class="n">lat_point</span><span class="p">,</span> <span class="n">lon_point</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">-</span><span class="mf">12.5798399926</span><span class="p">,</span> <span class="mf">130.782907919</span><span class="p">,</span> <span class="mi">30000</span>
<span class="c1"># lat_point, lon_point, buffer = -12.5693189393, 135.033955268, 20000</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">lon_point</span><span class="p">,</span> <span class="n">lat_point</span><span class="p">,</span> <span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;WGS84&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:3577&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">),</span>
         <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">),</span>
         <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="s1">&#39;EPSG:3577&#39;</span><span class="p">,</span>
          <span class="o">**</span><span class="n">data_func_params</span><span class="p">}</span>

<span class="c1"># Load data from datacube</span>
<span class="n">analysis_xarray</span> <span class="o">=</span> <span class="n">data_func</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># Run classification and export to file</span>
<span class="n">class_array</span><span class="p">,</span> <span class="n">prob_array</span> <span class="o">=</span> <span class="n">randomforest_classify</span><span class="p">(</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">,</span>
                                                <span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_xarray</span><span class="p">,</span>
                                                <span class="n">classification_output</span> <span class="o">=</span> <span class="n">classification_output</span><span class="p">,</span>
                                                <span class="n">class_prob</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot input data as reference</span>
<span class="n">three_band_image</span><span class="p">(</span><span class="n">analysis_xarray</span><span class="p">,</span>
                 <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">analysis_xarray</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                 <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Analysis data&#39;</span><span class="p">,</span>
                 <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">6.45</span><span class="p">])</span>

<span class="c1"># Plot output classification</span>
<span class="n">class_xarray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">class_array</span><span class="p">,</span>
                   <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">analysis_xarray</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">analysis_xarray</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                   <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
                   <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Classification output&quot;</span><span class="p">)</span>
<span class="n">class_xarray</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">class_array</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">class_array</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                  <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot predicted class probability (proportion of trees agreeing with classification)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">prob_xarray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">prob_array</span><span class="p">,</span>
                           <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">analysis_xarray</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">analysis_xarray</span><span class="o">.</span><span class="n">x</span><span class="p">],</span>
                           <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
                           <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Predicted class probability&quot;</span><span class="p">)</span>
<span class="n">prob_xarray</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;plasma_r&quot;</span><span class="p">,</span>
                 <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">prob_array</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                 <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">prob_array</span><span class="p">,</span> <span class="mi">97</span><span class="p">),</span>
                 <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data to classify:
  Rows: 2401
  Columns: 2401
  Bands: 12

Classification processing...
  0 nodata cells removed
  Classification exported

Class probability processing...
  Class probability exported
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[86]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;matplotlib.collections.QuadMesh at 0x7f5a1346e320&gt;
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_12_2.png" src="../../_images/notebooks_algorithms_RandomForestClassification_12_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_12_3.png" src="../../_images/notebooks_algorithms_RandomForestClassification_12_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_12_4.png" src="../../_images/notebooks_algorithms_RandomForestClassification_12_4.png" />
</div>
</div>
</div>
<div class="section" id="Feature/band/variable-importance">
<h2>Feature/band/variable importance<a class="headerlink" href="#Feature/band/variable-importance" title="Permalink to this headline">¶</a></h2>
<p>Extract classifier estimates of the relative importance of each
band/variable for training the classifier. Useful for potentially
selecting a subset of input bands/variables for model
training/classification (i.e. optimising feature space)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#  Extract feature importances from trained classifier</span>
<span class="n">importance</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">analysis_xarray</span><span class="o">.</span><span class="n">data_vars</span><span class="p">,</span>
                              <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance</span><span class="p">})</span>
<span class="n">importance_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">importance_df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Variable importance (global)&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">importance_df</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>importance</th>
    </tr>
    <tr>
      <th>variable</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lt_blue</th>
      <td>0.067479</td>
    </tr>
    <tr>
      <th>lt_green</th>
      <td>0.056581</td>
    </tr>
    <tr>
      <th>lt_red</th>
      <td>0.044614</td>
    </tr>
    <tr>
      <th>lt_nir</th>
      <td>0.067205</td>
    </tr>
    <tr>
      <th>lt_swir1</th>
      <td>0.080543</td>
    </tr>
    <tr>
      <th>lt_swir2</th>
      <td>0.122679</td>
    </tr>
    <tr>
      <th>ht_blue</th>
      <td>0.059830</td>
    </tr>
    <tr>
      <th>ht_green</th>
      <td>0.060820</td>
    </tr>
    <tr>
      <th>ht_red</th>
      <td>0.036466</td>
    </tr>
    <tr>
      <th>ht_nir</th>
      <td>0.076205</td>
    </tr>
    <tr>
      <th>ht_swir1</th>
      <td>0.130176</td>
    </tr>
    <tr>
      <th>ht_swir2</th>
      <td>0.197402</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_14_1.png" src="../../_images/notebooks_algorithms_RandomForestClassification_14_1.png" />
</div>
</div>
</div>
<div class="section" id="Plot-performance-of-model-by-parameter-values">
<h2>Plot performance of model by parameter values<a class="headerlink" href="#Plot-performance-of-model-by-parameter-values" title="Permalink to this headline">¶</a></h2>
<p>Random forest classifiers contain many modifiable parameters that can
strongly affect the performance of the model. This section evaluates the
effect of these parameters by plotting out-of-bag (OOB) error for a set
of classifier parameter scenarios, and exports the resulting plots to
file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Test effect of max features</span>
<span class="n">classifier_scenario1</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;max_features = &#39;sqrt&#39;&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_features</span> <span class="o">=</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;max_features = &#39;log2&#39;&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_features</span> <span class="o">=</span> <span class="s2">&quot;log2&quot;</span><span class="p">)),</span>

                       <span class="p">(</span><span class="s2">&quot;max_features = &#39;0.1&#39;&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_features</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>

                       <span class="p">(</span><span class="s2">&quot;max_features = &#39;0.5&#39;&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_features</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;max_features = None&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_features</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))]</span>

<span class="c1"># Test effect of minimum samples per leaf</span>
<span class="n">classifier_scenario2</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Leaf = 1&quot;</span><span class="p">,</span>
                         <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Leaf = 10&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Leaf = 20&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Leaf = 40&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))]</span>

<span class="c1"># Test effect of max depth</span>
<span class="n">classifier_scenario3</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Max depth = 1&quot;</span><span class="p">,</span>
                         <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max depth = 2&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max depth = 5&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max depth = 10&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))]</span>

<span class="c1"># Test effect of max leaf node</span>
<span class="n">classifier_scenario4</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Max leaf node = 5&quot;</span><span class="p">,</span>
                         <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="n">max_leaf_nodes</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                                <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max leaf node = 10&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_leaf_nodes</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max leaf node = 20&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_leaf_nodes</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Max leaf node = 40&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">max_leaf_nodes</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))]</span>

<span class="c1"># Test effect of max leaf node</span>
<span class="n">classifier_scenario5</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Min samples split = 5&quot;</span><span class="p">,</span>
                         <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="n">min_samples_split</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                                <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Min samples split = 10&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_split</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Min samples split = 20&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_split</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span>
                       <span class="p">(</span><span class="s2">&quot;Min samples split = 40&quot;</span><span class="p">,</span>
                        <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">min_samples_split</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
                                               <span class="n">oob_score</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))]</span>

<span class="c1"># Produce figures and export plots for each set of classification scenarios</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">classifier_scenario</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">classifier_scenario1</span><span class="p">,</span>
                                         <span class="n">classifier_scenario2</span><span class="p">,</span>
                                         <span class="n">classifier_scenario3</span><span class="p">,</span>
                                         <span class="n">classifier_scenario4</span><span class="p">,</span>
                                         <span class="n">classifier_scenario5</span><span class="p">]):</span>

    <span class="c1"># Plot OOB error by classifier scenario</span>
    <span class="n">randomforest_eval</span><span class="p">(</span><span class="n">training_labels</span> <span class="o">=</span> <span class="n">train_lab</span><span class="p">,</span>
                      <span class="n">training_samples</span> <span class="o">=</span> <span class="n">train_samp</span><span class="p">,</span>
                      <span class="n">classifier_scenario</span> <span class="o">=</span> <span class="n">classifier_scenario</span><span class="p">,</span>
                      <span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;figures/random_forest_params_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">max_estimators</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_16_0.png" src="../../_images/notebooks_algorithms_RandomForestClassification_16_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_16_1.png" src="../../_images/notebooks_algorithms_RandomForestClassification_16_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_16_2.png" src="../../_images/notebooks_algorithms_RandomForestClassification_16_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_16_3.png" src="../../_images/notebooks_algorithms_RandomForestClassification_16_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_16_4.png" src="../../_images/notebooks_algorithms_RandomForestClassification_16_4.png" />
</div>
</div>
</div>
<div class="section" id="Export-tree-diagrams">
<h2>Export tree diagrams<a class="headerlink" href="#Export-tree-diagrams" title="Permalink to this headline">¶</a></h2>
<p>Export .png plots of each decision tree in the random forest ensemble.
Useful for inspecting the splits used by the classifier to classify the
data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Plot output random forest trees to file</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tree_in_forest</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>

    <span class="c1"># Create graph and save to dot file</span>
    <span class="n">export_graphviz</span><span class="p">(</span><span class="n">tree_in_forest</span><span class="p">,</span>
                    <span class="n">out_file</span> <span class="o">=</span> <span class="s2">&quot;figures/tree_graphs/tree.dot&quot;</span><span class="p">,</span>
                    <span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">analysis_xarray</span><span class="o">.</span><span class="n">data_vars</span><span class="p">),</span>
                    <span class="n">class_names</span> <span class="o">=</span> <span class="n">classification_names</span><span class="p">,</span>
                    <span class="n">filled</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">rounded</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot as figure</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;dot -Tpng figures/tree_graphs/tree.dot -o &#39;</span> <span class="o">+</span> \
              <span class="s1">&#39;figures/tree_graphs/tree&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>

<span class="c1"># Plot first resulting tree</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;figures/tree_graphs/tree1.png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_algorithms_RandomForestClassification_18_0.png" src="../../_images/notebooks_algorithms_RandomForestClassification_18_0.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../case_studies/README.html" class="btn btn-neutral float-right" title="Case Studies" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ProduceFalseColourGeotiffs.html" class="btn btn-neutral" title="ProduceFalseColourGeotiffs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>